<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>二进制部署Kubernetes Part3 - Viper的博客</title><meta name="Description" content="Welcome to viper&#39;s blog."><meta property="og:title" content="二进制部署Kubernetes Part3" />
<meta property="og:description" content="前言 系列目录 二进制部署Kubernetes Part1 二进制部署Kubernetes Part2 二进制部署Kubernetes Part3(本篇) 二进制部署Kub" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.viper.pub/k8s-install-hardway-3/" />
<meta property="og:image" content="https://www.viper.pub/logo.png"/>
<meta property="article:published_time" content="2019-12-10T06:51:03+08:00" />
<meta property="article:modified_time" content="2020-08-11T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.viper.pub/logo.png"/>

<meta name="twitter:title" content="二进制部署Kubernetes Part3"/>
<meta name="twitter:description" content="前言 系列目录 二进制部署Kubernetes Part1 二进制部署Kubernetes Part2 二进制部署Kubernetes Part3(本篇) 二进制部署Kub"/>
<meta name="application-name" content="Viper&#39;s Blog">
<meta name="apple-mobile-web-app-title" content="Viper&#39;s Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="https://gitee.com/AbyssViper/pic/raw/master/images/ico.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://www.viper.pub/k8s-install-hardway-3/" /><link rel="prev" href="https://www.viper.pub/k8s-install-hardway-2/" /><link rel="next" href="https://www.viper.pub/k8s-install-hardway-4/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.a12cacf4b5b41234196cb89042b24a70.css" integrity="md5-oSys9LW0EjQZbLiQQrJKcA=="><link rel="stylesheet" href="/css/style.min.f03a2ec71b16efbe4f24352e542c93a9.css" integrity="md5-8DouxxsW775PJDUuVCyTqQ=="><link rel="stylesheet" href="/lib/fontawesome-free/all.min.26386564b5cf1594be24059af1cd0db9.css" integrity="md5-JjhlZLXPFZS&#43;JAWa8c0NuQ=="><link rel="stylesheet" href="/lib/animate/animate.min.43d6b8fdf324505f0ceb7ea698d0b7a5.css" integrity="md5-Q9a4/fMkUF8M636mmNC3pQ=="><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "二进制部署Kubernetes Part3",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/www.viper.pub\/k8s-install-hardway-3\/"
        },"genre": "posts","keywords": "Kubernetes","wordcount":  10799 ,
        "url": "https:\/\/www.viper.pub\/k8s-install-hardway-3\/","datePublished": "2019-12-10T06:51:03+08:00","dateModified": "2020-08-11T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "abyssviper"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Viper的博客"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/AbyssViper/pic/raw/master/images/logo.png"
        data-srcset="https://gitee.com/AbyssViper/pic/raw/master/images/logo.png, https://gitee.com/AbyssViper/pic/raw/master/images/logo.png 1.5x, https://gitee.com/AbyssViper/pic/raw/master/images/logo.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/AbyssViper/pic/raw/master/images/logo.png"
        title="https://gitee.com/AbyssViper/pic/raw/master/images/logo.png" />Viper的博客</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Viper的博客"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/AbyssViper/pic/raw/master/images/logo.png"
        data-srcset="https://gitee.com/AbyssViper/pic/raw/master/images/logo.png, https://gitee.com/AbyssViper/pic/raw/master/images/logo.png 1.5x, https://gitee.com/AbyssViper/pic/raw/master/images/logo.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/AbyssViper/pic/raw/master/images/logo.png"
        title="https://gitee.com/AbyssViper/pic/raw/master/images/logo.png" />Viper的博客</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">二进制部署Kubernetes Part3</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://www.viper.pub" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>abyssviper</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/kubernetes/"><i class="far fa-folder fa-fw"></i>Kubernetes</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2019-12-10">2019-12-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 10799 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 22 分钟&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://gitee.com/AbyssViper/pic/raw/master/images/k8s-install-hardway/featuredImage3.png"
        data-srcset="https://gitee.com/AbyssViper/pic/raw/master/images/k8s-install-hardway/featuredImage3.png, https://gitee.com/AbyssViper/pic/raw/master/images/k8s-install-hardway/featuredImage3.png 1.5x, https://gitee.com/AbyssViper/pic/raw/master/images/k8s-install-hardway/featuredImage3.png 2x"
        data-sizes="auto"
        alt="https://gitee.com/AbyssViper/pic/raw/master/images/k8s-install-hardway/featuredImage3.png"
        title="https://gitee.com/AbyssViper/pic/raw/master/images/k8s-install-hardway/featuredImage3.png" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a>
      <ul>
        <li><a href="#系列目录">系列目录</a></li>
        <li><a href="#注意点">注意点</a></li>
      </ul>
    </li>
    <li><a href="#master节点部署">master节点部署</a>
      <ul>
        <li><a href="#下载二进制并分发">下载二进制并分发</a></li>
        <li><a href="#kube-apiserver-集群部署">kube-apiserver 集群部署</a>
          <ul>
            <li><a href="#创建-kubernetes-master证书和私钥">创建 kubernetes-master证书和私钥</a></li>
            <li><a href="#创建加密配置文件">创建加密配置文件</a></li>
            <li><a href="#创建审计策略文件">创建审计策略文件</a></li>
            <li><a href="#创建证书用于访问">创建证书用于访问</a></li>
            <li><a href="#创建-kube-apiserver-systemd-unit-模板文件">创建 kube-apiserver systemd unit 模板文件</a></li>
            <li><a href="#启动-kube-apiserver-服务">启动 kube-apiserver 服务</a></li>
            <li><a href="#检查服务运行状态">检查服务运行状态</a></li>
            <li><a href="#检查集群状态">检查集群状态</a></li>
            <li><a href="#检查-kube-apiserver-监听的端口">检查 kube-apiserver 监听的端口</a></li>
          </ul>
        </li>
        <li><a href="#kube-controller-manager-部署">kube-controller-manager 部署</a>
          <ul>
            <li><a href="#创建kube-controller-manager-证书和私钥">创建kube-controller-manager 证书和私钥</a></li>
            <li><a href="#创建并分发-kubeconfig文件">创建并分发 kubeconfig文件</a></li>
            <li><a href="#创建-kube-controller-manager-systemd-unit-模板文件">创建 kube-controller-manager systemd unit 模板文件</a></li>
            <li><a href="#为各节点创建和分发-kube-controller-mananger-systemd-unit-文件">为各节点创建和分发 kube-controller-mananger systemd unit 文件</a></li>
            <li><a href="#启动服务并检查">启动服务并检查</a></li>
            <li><a href="#查看输出的metrics">查看输出的metrics</a></li>
            <li><a href="#查看-leader-节点">查看 leader 节点</a></li>
          </ul>
        </li>
        <li><a href="#kube-scheduler-部署">kube-scheduler 部署</a>
          <ul>
            <li><a href="#创建-kube-scheduler-证书和私钥">创建 kube-scheduler 证书和私钥</a></li>
            <li><a href="#创建和分发-kubeconfig-文件">创建和分发 kubeconfig 文件</a></li>
            <li><a href="#创建-kube-scheduler-配置文件">创建 kube-scheduler 配置文件</a></li>
            <li><a href="#创建-kube-scheduler-systemd-unit-模板文件">创建 kube-scheduler systemd unit 模板文件</a></li>
            <li><a href="#为各节点创建和分发-kube-scheduler-systemd-unit-文件">为各节点创建和分发 kube-scheduler systemd unit 文件</a></li>
            <li><a href="#启动-kube-schduler-服务">启动 kube-schduler 服务</a></li>
            <li><a href="#检查服务状态">检查服务状态</a></li>
            <li><a href="#查看输出的metrics-1">查看输出的metrics</a></li>
            <li><a href="#查看当前-leader">查看当前 leader</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#work节点部署">work节点部署</a>
      <ul>
        <li><a href="#api-server-高可用">api server 高可用</a>
          <ul>
            <li><a href="#下载编译安装-nginx">下载编译安装 Nginx</a></li>
            <li><a href="#安装部署">安装部署</a></li>
            <li><a href="#配置-systemd-unit-文件-与-启动服务">配置 systemd unit 文件 与 启动服务</a></li>
            <li><a href="#验证-kube-nginx">验证 kube-nginx</a></li>
          </ul>
        </li>
        <li><a href="#部署-containerd">部署 containerd</a>
          <ul>
            <li><a href="#下载分发二进制">下载分发二进制</a></li>
            <li><a href="#创建分发-containerd-配置文件">创建分发 containerd 配置文件</a></li>
            <li><a href="#创建-分发-containerd-systemd-unit-配置文件">创建 分发 containerd systemd unit 配置文件</a></li>
            <li><a href="#创建分发-crictl-配置文件">创建分发 crictl 配置文件</a></li>
          </ul>
        </li>
        <li><a href="#部署-kubelet">部署 kubelet</a>
          <ul>
            <li><a href="#下载分发">下载分发</a></li>
            <li><a href="#创建-kubelet-bootstrap-kubeconfig-文件">创建 kubelet bootstrap kubeconfig 文件</a></li>
            <li><a href="#分发-bootstrap-kubeconfig-文件到所有-worker-节点">分发 bootstrap kubeconfig 文件到所有 worker 节点</a></li>
            <li><a href="#创建分发kubelet-参数配置文件">创建分发kubelet 参数配置文件</a></li>
            <li><a href="#创建分发-kubelet-systemd-unit-文件">创建分发 kubelet systemd unit 文件</a></li>
            <li><a href="#授予-kube-apiserver-访问-kubelet-api-的权限">授予 kube-apiserver 访问 kubelet API 的权限</a></li>
            <li><a href="#bootstrap-token-auth-和授予权限">Bootstrap Token Auth 和授予权限</a></li>
            <li><a href="#自动-approve-csr-请求生成-kubelet-client-证书">自动 approve CSR 请求，生成 kubelet client 证书</a></li>
            <li><a href="#启动-kubelet">启动 kubelet</a></li>
            <li><a href="#查看-kubelet-情况">查看 kubelet 情况</a></li>
            <li><a href="#手动-approve-server-cert-csr">手动 approve server cert csr</a></li>
            <li><a href="#bear-token-认证和授权">bear token 认证和授权</a></li>
            <li><a href="#cadvisor-和-metrics">cadvisor 和 metrics</a></li>
          </ul>
        </li>
        <li><a href="#部署-kube-proxy-组件">部署 kube-proxy 组件</a>
          <ul>
            <li><a href="#创建-kube-proxy-证书">创建 kube-proxy 证书</a></li>
            <li><a href="#创建和分发-kubeconfig-文件-1">创建和分发 kubeconfig 文件</a></li>
            <li><a href="#创建-kube-proxy-配置文件">创建 kube-proxy 配置文件</a></li>
            <li><a href="#创建和分发-kube-proxy-systemd-unit-文件">创建和分发 kube-proxy systemd unit 文件</a></li>
            <li><a href="#启动-kube-proxy-服务">启动 kube-proxy 服务</a></li>
            <li><a href="#查看监听端口">查看监听端口</a></li>
            <li><a href="#查看-ipvs-路由规则">查看 ipvs 路由规则</a></li>
          </ul>
        </li>
        <li><a href="#部署calico网络组件">部署Calico网络组件</a>
          <ul>
            <li><a href="#安装部署-1">安装部署</a></li>
            <li><a href="#检查-calico">检查 calico</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#验证功能">验证功能</a>
      <ul>
        <li><a href="#检查节点功能">检查节点功能</a></li>
        <li><a href="#创建测试文件">创建测试文件</a></li>
        <li><a href="#执行测试">执行测试</a></li>
        <li><a href="#检查节点-pod-ip-连通性">检查节点 POD IP 连通性</a></li>
        <li><a href="#检查服务ip-和-端口可达性">检查服务IP 和 端口可达性</a></li>
        <li><a href="#检查服务-nodeport-可达性">检查服务 NodePort 可达性</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="前言">前言</h2>
<h3 id="系列目录">系列目录</h3>
<ul>
<li><a href="https://www.viper.pub/k8s-install-hardway-1/" target="_blank" rel="noopener noreffer">二进制部署Kubernetes Part1</a></li>
<li><a href="https://www.viper.pub/k8s-install-hardway-2/" target="_blank" rel="noopener noreffer">二进制部署Kubernetes Part2</a></li>
<li><a href="https://www.viper.pub/k8s-install-hardway-3/" target="_blank" rel="noopener noreffer">二进制部署Kubernetes Part3(本篇)</a></li>
<li><a href="https://www.viper.pub/k8s-install-hardway-4/" target="_blank" rel="noopener noreffer">二进制部署Kubernetes Part4</a></li>
</ul>
<h3 id="注意点">注意点</h3>
<ul>
<li>本章节所有操作默认均在 <code>k8s-node01</code>下操作</li>
</ul>
<h2 id="master节点部署">master节点部署</h2>
<p>master 节点运行组件需要</p>
<ul>
<li>kube-apiserver</li>
<li>kube-scheduler</li>
<li>kube-controller-manager</li>
</ul>
<p>kube-apiserver，kube-scheduler 与 kube-controller-manager 均以多实例模式运行</p>
<ul>
<li>
<p>kube-scheduler 与 kube-controller-manager 会自动选举产生一个 leader 实例，其他实例处于阻塞状态；leader 挂掉以后，重新选举产生新的 leader，保证服务的可用性</p>
</li>
<li>
<p>kube-apiserver 是无状态的，可以通过 kube-nginx 进行代理访问，保证服务可用性</p>
</li>
</ul>
<h3 id="下载二进制并分发">下载二进制并分发</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
wget https://dl.k8s.io/v1.16.6/kubernetes-server-linux-amd64.tar.gz
tar -xzvf kubernetes-server-linux-amd64.tar.gz
<span class="nb">cd</span> kubernetes
tar -xzvf  kubernetes-src.tar.gz
</code></pre></td></tr></table>
</div>
</div><ul>
<li>拷贝二进制文件到所有 master节点</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kubernetes/server/bin/<span class="o">{</span>apiextensions-apiserver,kube-apiserver,kube-controller-manager,kube-proxy,kube-scheduler,kubeadm,kubectl,kubelet,mounter<span class="o">}</span> root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/opt/k8s/bin/
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;chmod +x /opt/k8s/bin/*&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="kube-apiserver-集群部署">kube-apiserver 集群部署</h3>
<h4 id="创建-kubernetes-master证书和私钥">创建 kubernetes-master证书和私钥</h4>
<p>创建证书请求</p>
<ul>
<li>hosts字段指定授权使用该证书的 IP 和 域名列表</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
cat &gt; kubernetes-csr.json <span class="s">&lt;&lt;EOF
</span><span class="s">{
</span><span class="s">  &#34;CN&#34;: &#34;kubernetes-master&#34;,
</span><span class="s">  &#34;hosts&#34;: [
</span><span class="s">    &#34;127.0.0.1&#34;,
</span><span class="s">    &#34;192.168.7.200&#34;,
</span><span class="s">    &#34;192.168.7.201&#34;,
</span><span class="s">    &#34;192.168.7.202&#34;,
</span><span class="s">    &#34;${CLUSTER_KUBERNETES_SVC_IP}&#34;,
</span><span class="s">    &#34;kubernetes&#34;,
</span><span class="s">    &#34;kubernetes.default&#34;,
</span><span class="s">    &#34;kubernetes.default.svc&#34;,
</span><span class="s">    &#34;kubernetes.default.svc.cluster&#34;,
</span><span class="s">    &#34;kubernetes.default.svc.cluster.local.&#34;,
</span><span class="s">    &#34;kubernetes.default.svc.${CLUSTER_DNS_DOMAIN}.&#34;
</span><span class="s">  ],
</span><span class="s">  &#34;key&#34;: {
</span><span class="s">    &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">    &#34;size&#34;: 2048
</span><span class="s">  },
</span><span class="s">  &#34;names&#34;: [
</span><span class="s">    {
</span><span class="s">      &#34;C&#34;: &#34;CN&#34;,
</span><span class="s">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;L&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;O&#34;: &#34;k8s&#34;,
</span><span class="s">      &#34;OU&#34;: &#34;opsnull&#34;
</span><span class="s">    }
</span><span class="s">  ]
</span><span class="s">}
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>生成证书和私钥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">cfssl gencert -ca<span class="o">=</span>/opt/k8s/work/ca.pem <span class="se">\
</span><span class="se"></span>  -ca-key<span class="o">=</span>/opt/k8s/work/ca-key.pem <span class="se">\
</span><span class="se"></span>  -config<span class="o">=</span>/opt/k8s/work/ca-config.json <span class="se">\
</span><span class="se"></span>  -profile<span class="o">=</span>kubernetes kubernetes-csr.json <span class="p">|</span> cfssljson -bare kubernetes
ls kubernetes*pem
</code></pre></td></tr></table>
</div>
</div><p>将生成的证书和私钥文件拷贝到所有 master 节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;mkdir -p /etc/kubernetes/cert&#34;</span>
    scp kubernetes*.pem root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/kubernetes/cert/
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建加密配置文件">创建加密配置文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
cat &gt; encryption-config.yaml <span class="s">&lt;&lt;EOF
</span><span class="s">kind: EncryptionConfig
</span><span class="s">apiVersion: v1
</span><span class="s">resources:
</span><span class="s">  - resources:
</span><span class="s">      - secrets
</span><span class="s">    providers:
</span><span class="s">      - aescbc:
</span><span class="s">          keys:
</span><span class="s">            - name: key1
</span><span class="s">              secret: ${ENCRYPTION_KEY}
</span><span class="s">      - identity: {}
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>将加密配置文件拷贝到 master 节点的 <code>/etc/kubernetes</code> 目录下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp encryption-config.yaml root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/kubernetes/
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建审计策略文件">创建审计策略文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
cat &gt; audit-policy.yaml <span class="s">&lt;&lt;EOF
</span><span class="s">apiVersion: audit.k8s.io/v1beta1
</span><span class="s">kind: Policy
</span><span class="s">rules:
</span><span class="s">  # The following requests were manually identified as high-volume and low-risk, so drop them.
</span><span class="s">  - level: None
</span><span class="s">    resources:
</span><span class="s">      - group: &#34;&#34;
</span><span class="s">        resources:
</span><span class="s">          - endpoints
</span><span class="s">          - services
</span><span class="s">          - services/status
</span><span class="s">    users:
</span><span class="s">      - &#39;system:kube-proxy&#39;
</span><span class="s">    verbs:
</span><span class="s">      - watch
</span><span class="s">
</span><span class="s">  - level: None
</span><span class="s">    resources:
</span><span class="s">      - group: &#34;&#34;
</span><span class="s">        resources:
</span><span class="s">          - nodes
</span><span class="s">          - nodes/status
</span><span class="s">    userGroups:
</span><span class="s">      - &#39;system:nodes&#39;
</span><span class="s">    verbs:
</span><span class="s">      - get
</span><span class="s">
</span><span class="s">  - level: None
</span><span class="s">    namespaces:
</span><span class="s">      - kube-system
</span><span class="s">    resources:
</span><span class="s">      - group: &#34;&#34;
</span><span class="s">        resources:
</span><span class="s">          - endpoints
</span><span class="s">    users:
</span><span class="s">      - &#39;system:kube-controller-manager&#39;
</span><span class="s">      - &#39;system:kube-scheduler&#39;
</span><span class="s">      - &#39;system:serviceaccount:kube-system:endpoint-controller&#39;
</span><span class="s">    verbs:
</span><span class="s">      - get
</span><span class="s">      - update
</span><span class="s">
</span><span class="s">  - level: None
</span><span class="s">    resources:
</span><span class="s">      - group: &#34;&#34;
</span><span class="s">        resources:
</span><span class="s">          - namespaces
</span><span class="s">          - namespaces/status
</span><span class="s">          - namespaces/finalize
</span><span class="s">    users:
</span><span class="s">      - &#39;system:apiserver&#39;
</span><span class="s">    verbs:
</span><span class="s">      - get
</span><span class="s">
</span><span class="s">  # Don&#39;t log HPA fetching metrics.
</span><span class="s">  - level: None
</span><span class="s">    resources:
</span><span class="s">      - group: metrics.k8s.io
</span><span class="s">    users:
</span><span class="s">      - &#39;system:kube-controller-manager&#39;
</span><span class="s">    verbs:
</span><span class="s">      - get
</span><span class="s">      - list
</span><span class="s">
</span><span class="s">  # Don&#39;t log these read-only URLs.
</span><span class="s">  - level: None
</span><span class="s">    nonResourceURLs:
</span><span class="s">      - &#39;/healthz*&#39;
</span><span class="s">      - /version
</span><span class="s">      - &#39;/swagger*&#39;
</span><span class="s">
</span><span class="s">  # Don&#39;t log events requests.
</span><span class="s">  - level: None
</span><span class="s">    resources:
</span><span class="s">      - group: &#34;&#34;
</span><span class="s">        resources:
</span><span class="s">          - events
</span><span class="s">
</span><span class="s">  # node and pod status calls from nodes are high-volume and can be large, don&#39;t log responses
</span><span class="s">  # for expected updates from nodes
</span><span class="s">  - level: Request
</span><span class="s">    omitStages:
</span><span class="s">      - RequestReceived
</span><span class="s">    resources:
</span><span class="s">      - group: &#34;&#34;
</span><span class="s">        resources:
</span><span class="s">          - nodes/status
</span><span class="s">          - pods/status
</span><span class="s">    users:
</span><span class="s">      - kubelet
</span><span class="s">      - &#39;system:node-problem-detector&#39;
</span><span class="s">      - &#39;system:serviceaccount:kube-system:node-problem-detector&#39;
</span><span class="s">    verbs:
</span><span class="s">      - update
</span><span class="s">      - patch
</span><span class="s">
</span><span class="s">  - level: Request
</span><span class="s">    omitStages:
</span><span class="s">      - RequestReceived
</span><span class="s">    resources:
</span><span class="s">      - group: &#34;&#34;
</span><span class="s">        resources:
</span><span class="s">          - nodes/status
</span><span class="s">          - pods/status
</span><span class="s">    userGroups:
</span><span class="s">      - &#39;system:nodes&#39;
</span><span class="s">    verbs:
</span><span class="s">      - update
</span><span class="s">      - patch
</span><span class="s">
</span><span class="s">  # deletecollection calls can be large, don&#39;t log responses for expected namespace deletions
</span><span class="s">  - level: Request
</span><span class="s">    omitStages:
</span><span class="s">      - RequestReceived
</span><span class="s">    users:
</span><span class="s">      - &#39;system:serviceaccount:kube-system:namespace-controller&#39;
</span><span class="s">    verbs:
</span><span class="s">      - deletecollection
</span><span class="s">
</span><span class="s">  # Secrets, ConfigMaps, and TokenReviews can contain sensitive &amp; binary data,
</span><span class="s">  # so only log at the Metadata level.
</span><span class="s">  - level: Metadata
</span><span class="s">    omitStages:
</span><span class="s">      - RequestReceived
</span><span class="s">    resources:
</span><span class="s">      - group: &#34;&#34;
</span><span class="s">        resources:
</span><span class="s">          - secrets
</span><span class="s">          - configmaps
</span><span class="s">      - group: authentication.k8s.io
</span><span class="s">        resources:
</span><span class="s">          - tokenreviews
</span><span class="s">  # Get repsonses can be large; skip them.
</span><span class="s">  - level: Request
</span><span class="s">    omitStages:
</span><span class="s">      - RequestReceived
</span><span class="s">    resources:
</span><span class="s">      - group: &#34;&#34;
</span><span class="s">      - group: admissionregistration.k8s.io
</span><span class="s">      - group: apiextensions.k8s.io
</span><span class="s">      - group: apiregistration.k8s.io
</span><span class="s">      - group: apps
</span><span class="s">      - group: authentication.k8s.io
</span><span class="s">      - group: authorization.k8s.io
</span><span class="s">      - group: autoscaling
</span><span class="s">      - group: batch
</span><span class="s">      - group: certificates.k8s.io
</span><span class="s">      - group: extensions
</span><span class="s">      - group: metrics.k8s.io
</span><span class="s">      - group: networking.k8s.io
</span><span class="s">      - group: policy
</span><span class="s">      - group: rbac.authorization.k8s.io
</span><span class="s">      - group: scheduling.k8s.io
</span><span class="s">      - group: settings.k8s.io
</span><span class="s">      - group: storage.k8s.io
</span><span class="s">    verbs:
</span><span class="s">      - get
</span><span class="s">      - list
</span><span class="s">      - watch
</span><span class="s">
</span><span class="s">  # Default level for known APIs
</span><span class="s">  - level: RequestResponse
</span><span class="s">    omitStages:
</span><span class="s">      - RequestReceived
</span><span class="s">    resources:
</span><span class="s">      - group: &#34;&#34;
</span><span class="s">      - group: admissionregistration.k8s.io
</span><span class="s">      - group: apiextensions.k8s.io
</span><span class="s">      - group: apiregistration.k8s.io
</span><span class="s">      - group: apps
</span><span class="s">      - group: authentication.k8s.io
</span><span class="s">      - group: authorization.k8s.io
</span><span class="s">      - group: autoscaling
</span><span class="s">      - group: batch
</span><span class="s">      - group: certificates.k8s.io
</span><span class="s">      - group: extensions
</span><span class="s">      - group: metrics.k8s.io
</span><span class="s">      - group: networking.k8s.io
</span><span class="s">      - group: policy
</span><span class="s">      - group: rbac.authorization.k8s.io
</span><span class="s">      - group: scheduling.k8s.io
</span><span class="s">      - group: settings.k8s.io
</span><span class="s">      - group: storage.k8s.io
</span><span class="s">      
</span><span class="s">  # Default level for all other requests.
</span><span class="s">  - level: Metadata
</span><span class="s">    omitStages:
</span><span class="s">      - RequestReceived
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>分发审计策略文件</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp audit-policy.yaml root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/kubernetes/audit-policy.yaml
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建证书用于访问">创建证书用于访问</h4>
<ul>
<li>CN 名称需要位于 kube-apiserver 的 <code>--requestheader-allowed-names</code> 参数中，否则后续访问 metrics 时会提示权限不足。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cat &gt; proxy-client-csr.json <span class="s">&lt;&lt;EOF
</span><span class="s">{
</span><span class="s">  &#34;CN&#34;: &#34;aggregator&#34;,
</span><span class="s">  &#34;hosts&#34;: [],
</span><span class="s">  &#34;key&#34;: {
</span><span class="s">    &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">    &#34;size&#34;: 2048
</span><span class="s">  },
</span><span class="s">  &#34;names&#34;: [
</span><span class="s">    {
</span><span class="s">      &#34;C&#34;: &#34;CN&#34;,
</span><span class="s">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;L&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;O&#34;: &#34;k8s&#34;,
</span><span class="s">      &#34;OU&#34;: &#34;opsnull&#34;
</span><span class="s">    }
</span><span class="s">  ]
</span><span class="s">}
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">cfssl gencert -ca<span class="o">=</span>/etc/kubernetes/cert/ca.pem <span class="se">\
</span><span class="se"></span>  -ca-key<span class="o">=</span>/etc/kubernetes/cert/ca-key.pem  <span class="se">\
</span><span class="se"></span>  -config<span class="o">=</span>/etc/kubernetes/cert/ca-config.json  <span class="se">\
</span><span class="se"></span>  -profile<span class="o">=</span>kubernetes proxy-client-csr.json <span class="p">|</span> cfssljson -bare proxy-client
ls proxy-client*.pem
</code></pre></td></tr></table>
</div>
</div><ul>
<li>分发到所有 master节点</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp proxy-client*.pem root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/kubernetes/cert/
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建-kube-apiserver-systemd-unit-模板文件">创建 kube-apiserver systemd unit 模板文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
cat &gt; kube-apiserver.service.template <span class="s">&lt;&lt;EOF
</span><span class="s">[Unit]
</span><span class="s">Description=Kubernetes API Server
</span><span class="s">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span><span class="s">After=network.target
</span><span class="s">
</span><span class="s">[Service]
</span><span class="s">WorkingDirectory=${K8S_DIR}/kube-apiserver
</span><span class="s">ExecStart=/opt/k8s/bin/kube-apiserver \\
</span><span class="s">  --advertise-address=##NODE_IP## \\
</span><span class="s">  --default-not-ready-toleration-seconds=360 \\
</span><span class="s">  --default-unreachable-toleration-seconds=360 \\
</span><span class="s">  --feature-gates=DynamicAuditing=true \\
</span><span class="s">  --max-mutating-requests-inflight=2000 \\
</span><span class="s">  --max-requests-inflight=4000 \\
</span><span class="s">  --default-watch-cache-size=200 \\
</span><span class="s">  --delete-collection-workers=2 \\
</span><span class="s">  --encryption-provider-config=/etc/kubernetes/encryption-config.yaml \\
</span><span class="s">  --etcd-cafile=/etc/kubernetes/cert/ca.pem \\
</span><span class="s">  --etcd-certfile=/etc/kubernetes/cert/kubernetes.pem \\
</span><span class="s">  --etcd-keyfile=/etc/kubernetes/cert/kubernetes-key.pem \\
</span><span class="s">  --etcd-servers=${ETCD_ENDPOINTS} \\
</span><span class="s">  --bind-address=##NODE_IP## \\
</span><span class="s">  --secure-port=6443 \\
</span><span class="s">  --tls-cert-file=/etc/kubernetes/cert/kubernetes.pem \\
</span><span class="s">  --tls-private-key-file=/etc/kubernetes/cert/kubernetes-key.pem \\
</span><span class="s">  --insecure-port=0 \\
</span><span class="s">  --audit-dynamic-configuration \\
</span><span class="s">  --audit-log-maxage=15 \\
</span><span class="s">  --audit-log-maxbackup=3 \\
</span><span class="s">  --audit-log-maxsize=100 \\
</span><span class="s">  --audit-log-truncate-enabled \\
</span><span class="s">  --audit-log-path=${K8S_DIR}/kube-apiserver/audit.log \\
</span><span class="s">  --audit-policy-file=/etc/kubernetes/audit-policy.yaml \\
</span><span class="s">  --profiling \\
</span><span class="s">  --anonymous-auth=false \\
</span><span class="s">  --client-ca-file=/etc/kubernetes/cert/ca.pem \\
</span><span class="s">  --enable-bootstrap-token-auth \\
</span><span class="s">  --requestheader-allowed-names=&#34;aggregator&#34; \\
</span><span class="s">  --requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem \\
</span><span class="s">  --requestheader-extra-headers-prefix=&#34;X-Remote-Extra-&#34; \\
</span><span class="s">  --requestheader-group-headers=X-Remote-Group \\
</span><span class="s">  --requestheader-username-headers=X-Remote-User \\
</span><span class="s">  --service-account-key-file=/etc/kubernetes/cert/ca.pem \\
</span><span class="s">  --authorization-mode=Node,RBAC \\
</span><span class="s">  --runtime-config=api/all=true \\
</span><span class="s">  --enable-admission-plugins=NodeRestriction \\
</span><span class="s">  --allow-privileged=true \\
</span><span class="s">  --apiserver-count=3 \\
</span><span class="s">  --event-ttl=168h \\
</span><span class="s">  --kubelet-certificate-authority=/etc/kubernetes/cert/ca.pem \\
</span><span class="s">  --kubelet-client-certificate=/etc/kubernetes/cert/kubernetes.pem \\
</span><span class="s">  --kubelet-client-key=/etc/kubernetes/cert/kubernetes-key.pem \\
</span><span class="s">  --kubelet-https=true \\
</span><span class="s">  --kubelet-timeout=10s \\
</span><span class="s">  --proxy-client-cert-file=/etc/kubernetes/cert/proxy-client.pem \\
</span><span class="s">  --proxy-client-key-file=/etc/kubernetes/cert/proxy-client-key.pem \\
</span><span class="s">  --service-cluster-ip-range=${SERVICE_CIDR} \\
</span><span class="s">  --service-node-port-range=${NODE_PORT_RANGE} \\
</span><span class="s">  --logtostderr=true \\
</span><span class="s">  --v=2
</span><span class="s">Restart=on-failure
</span><span class="s">RestartSec=10
</span><span class="s">Type=notify
</span><span class="s">LimitNOFILE=65536
</span><span class="s">
</span><span class="s">[Install]
</span><span class="s">WantedBy=multi-user.target
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i &lt; 3<span class="p">;</span> i++ <span class="o">))</span>
  <span class="k">do</span>
    sed -e <span class="s2">&#34;s/##NODE_NAME##/</span><span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[i]</span><span class="si">}</span><span class="s2">/&#34;</span> -e <span class="s2">&#34;s/##NODE_IP##/</span><span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[i]</span><span class="si">}</span><span class="s2">/&#34;</span> kube-apiserver.service.template &gt; kube-apiserver-<span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[i]</span><span class="si">}</span>.service 
  <span class="k">done</span>
ls kube-apiserver*.service
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kube-apiserver-<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>.service root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/systemd/system/kube-apiserver.service
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="启动-kube-apiserver-服务">启动 kube-apiserver 服务</h4>
<ul>
<li>如果 <code>journalctl -u kube-apiserver</code> 检查服务错误 203，请检查二进制文件是否已经拷贝到指定路径</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;mkdir -p </span><span class="si">${</span><span class="nv">K8S_DIR</span><span class="si">}</span><span class="s2">/kube-apiserver&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl daemon-reload &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl restart kube-apiserver&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="检查服务运行状态">检查服务运行状态</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl status kube-apiserver |grep &#39;Active:&#39;&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="检查集群状态">检查集群状态</h4>
<ul>
<li>Kubernetes 1.16.6 存在 Bugs 导致返回结果一直为 <code>&lt;unknown&gt;</code>，但 <code>kubectl get cs -o yaml</code> 可以返回正确结果；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl cluster-info
kubectl get all --all-namespaces
kubectl get componentstatuses
</code></pre></td></tr></table>
</div>
</div><h4 id="检查-kube-apiserver-监听的端口">检查 kube-apiserver 监听的端口</h4>
<ul>
<li>输出 <code>6443</code> 为监听端口，该端口接收 https 请求，对所有请求做认证与授权</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">netstat -lnpt<span class="p">|</span>grep kube
</code></pre></td></tr></table>
</div>
</div><h3 id="kube-controller-manager-部署">kube-controller-manager 部署</h3>
<p>kube-controller-manager 两种情况下使用证书进行通信</p>
<ul>
<li>与 kube-apiserver 的安全端口通信</li>
<li>在安全端口（https：10252）输出 prometheus 格式的 metrics</li>
</ul>
<h4 id="创建kube-controller-manager-证书和私钥">创建kube-controller-manager 证书和私钥</h4>
<ul>
<li>创建证书签名请求</li>
<li>hosts 列表包含<strong>所有</strong> kube-controller-manager 节点 IP；</li>
<li>CN 和 O 均为 <code>system:kube-controller-manager</code>，kubernetes 内置的 ClusterRoleBindings <code>system:kube-controller-manager</code> 赋予 kube-controller-manager 工作所需的权限。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cat &gt; kube-controller-manager-csr.json <span class="s">&lt;&lt;EOF
</span><span class="s">{
</span><span class="s">    &#34;CN&#34;: &#34;system:kube-controller-manager&#34;,
</span><span class="s">    &#34;key&#34;: {
</span><span class="s">        &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">        &#34;size&#34;: 2048
</span><span class="s">    },
</span><span class="s">    &#34;hosts&#34;: [
</span><span class="s">      &#34;127.0.0.1&#34;,
</span><span class="s">      &#34;192.168.7.200&#34;,
</span><span class="s">      &#34;192.168.7.201&#34;,
</span><span class="s">      &#34;192.168.7.202&#34;
</span><span class="s">    ],
</span><span class="s">    &#34;names&#34;: [
</span><span class="s">      {
</span><span class="s">        &#34;C&#34;: &#34;CN&#34;,
</span><span class="s">        &#34;ST&#34;: &#34;BeiJing&#34;,
</span><span class="s">        &#34;L&#34;: &#34;BeiJing&#34;,
</span><span class="s">        &#34;O&#34;: &#34;system:kube-controller-manager&#34;,
</span><span class="s">        &#34;OU&#34;: &#34;opsnull&#34;
</span><span class="s">      }
</span><span class="s">    ]
</span><span class="s">}
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>生成并分发</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cfssl gencert -ca<span class="o">=</span>/opt/k8s/work/ca.pem <span class="se">\
</span><span class="se"></span>  -ca-key<span class="o">=</span>/opt/k8s/work/ca-key.pem <span class="se">\
</span><span class="se"></span>  -config<span class="o">=</span>/opt/k8s/work/ca-config.json <span class="se">\
</span><span class="se"></span>  -profile<span class="o">=</span>kubernetes kube-controller-manager-csr.json <span class="p">|</span> cfssljson -bare kube-controller-manager
ls kube-controller-manager*pem
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kube-controller-manager*.pem root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/kubernetes/cert/
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建并分发-kubeconfig文件">创建并分发 kubeconfig文件</h4>
<p>kube-controller-manager 使用 kubeconfig 文件访问 apiserver，该文件提供了 apiserver 地址、嵌入的 CA 证书和 kube-controller-manager 证书等信息：</p>
<ul>
<li>kube-controller-manager 与 kube-apiserver 混布，故直接通过<strong>节点 IP</strong> 访问 kube-apiserver；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
kubectl config set-cluster kubernetes <span class="se">\
</span><span class="se"></span>  --certificate-authority<span class="o">=</span>/opt/k8s/work/ca.pem <span class="se">\
</span><span class="se"></span>  --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --server<span class="o">=</span><span class="s2">&#34;https://##NODE_IP##:6443&#34;</span> <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-controller-manager.kubeconfig

kubectl config set-credentials system:kube-controller-manager <span class="se">\
</span><span class="se"></span>  --client-certificate<span class="o">=</span>kube-controller-manager.pem <span class="se">\
</span><span class="se"></span>  --client-key<span class="o">=</span>kube-controller-manager-key.pem <span class="se">\
</span><span class="se"></span>  --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-controller-manager.kubeconfig

kubectl config set-context system:kube-controller-manager <span class="se">\
</span><span class="se"></span>  --cluster<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>  --user<span class="o">=</span>system:kube-controller-manager <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-controller-manager.kubeconfig

kubectl config use-context system:kube-controller-manager --kubeconfig<span class="o">=</span>kube-controller-manager.kubeconfig
</code></pre></td></tr></table>
</div>
</div><p>分发 kubeconfig 至各个节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    sed -e <span class="s2">&#34;s/##NODE_IP##/</span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">/&#34;</span> kube-controller-manager.kubeconfig &gt; kube-controller-manager-<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>.kubeconfig
    scp kube-controller-manager-<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>.kubeconfig root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/kubernetes/kube-controller-manager.kubeconfig
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建-kube-controller-manager-systemd-unit-模板文件">创建 kube-controller-manager systemd unit 模板文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
cat &gt; kube-controller-manager.service.template <span class="s">&lt;&lt;EOF
</span><span class="s">[Unit]
</span><span class="s">Description=Kubernetes Controller Manager
</span><span class="s">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span><span class="s">
</span><span class="s">[Service]
</span><span class="s">WorkingDirectory=${K8S_DIR}/kube-controller-manager
</span><span class="s">ExecStart=/opt/k8s/bin/kube-controller-manager \\
</span><span class="s">  --profiling \\
</span><span class="s">  --cluster-name=kubernetes \\
</span><span class="s">  --controllers=*,bootstrapsigner,tokencleaner \\
</span><span class="s">  --kube-api-qps=1000 \\
</span><span class="s">  --kube-api-burst=2000 \\
</span><span class="s">  --leader-elect \\
</span><span class="s">  --use-service-account-credentials\\
</span><span class="s">  --concurrent-service-syncs=2 \\
</span><span class="s">  --bind-address=##NODE_IP## \\
</span><span class="s">  --secure-port=10252 \\
</span><span class="s">  --tls-cert-file=/etc/kubernetes/cert/kube-controller-manager.pem \\
</span><span class="s">  --tls-private-key-file=/etc/kubernetes/cert/kube-controller-manager-key.pem \\
</span><span class="s">  --port=0 \\
</span><span class="s">  --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\
</span><span class="s">  --client-ca-file=/etc/kubernetes/cert/ca.pem \\
</span><span class="s">  --requestheader-allowed-names=&#34;aggregator&#34; \\
</span><span class="s">  --requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem \\
</span><span class="s">  --requestheader-extra-headers-prefix=&#34;X-Remote-Extra-&#34; \\
</span><span class="s">  --requestheader-group-headers=X-Remote-Group \\
</span><span class="s">  --requestheader-username-headers=X-Remote-User \\
</span><span class="s">  --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\
</span><span class="s">  --cluster-signing-cert-file=/etc/kubernetes/cert/ca.pem \\
</span><span class="s">  --cluster-signing-key-file=/etc/kubernetes/cert/ca-key.pem \\
</span><span class="s">  --experimental-cluster-signing-duration=876000h \\
</span><span class="s">  --horizontal-pod-autoscaler-sync-period=10s \\
</span><span class="s">  --concurrent-deployment-syncs=10 \\
</span><span class="s">  --concurrent-gc-syncs=30 \\
</span><span class="s">  --node-cidr-mask-size=24 \\
</span><span class="s">  --service-cluster-ip-range=${SERVICE_CIDR} \\
</span><span class="s">  --pod-eviction-timeout=6m \\
</span><span class="s">  --terminated-pod-gc-threshold=10000 \\
</span><span class="s">  --root-ca-file=/etc/kubernetes/cert/ca.pem \\
</span><span class="s">  --service-account-private-key-file=/etc/kubernetes/cert/ca-key.pem \\
</span><span class="s">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\
</span><span class="s">  --logtostderr=true \\
</span><span class="s">  --v=2
</span><span class="s">Restart=on-failure
</span><span class="s">RestartSec=5
</span><span class="s">
</span><span class="s">[Install]
</span><span class="s">WantedBy=multi-user.target
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>&ndash;port=0</td>
<td>关闭监听非安全端口（http），同时 <code>--address</code> 参数无效，<code>--bind-address</code> 参数有效；</td>
</tr>
<tr>
<td>&ndash;secure-port=10252<code>、</code>&ndash;bind-address=0.0.0.0</td>
<td>在所有网络接口监听 10252 端口的 https /metrics 请求；</td>
</tr>
<tr>
<td>&ndash;kubeconfig</td>
<td>指定 kubeconfig 文件路径，kube-controller-manager 使用它连接和验证 kube-apiserver；</td>
</tr>
<tr>
<td>&ndash;authentication-kubeconfig<code>和</code>&ndash;authorization-kubeconfig</td>
<td>kube-controller-manager 使用它连接 apiserver，对 client 的请求进行认证和授权。<code>kube-controller-manager</code> 不再使用 <code>--tls-ca-file</code> 对请求 https metrics 的 Client 证书进行校验。如果没有配置这两个 kubeconfig 参数，则 client 连接 kube-controller-manager https 端口的请求会被拒绝(提示权限不足)。</td>
</tr>
<tr>
<td>&ndash;cluster-signing-*-file</td>
<td>签名 TLS Bootstrap 创建的证书；</td>
</tr>
<tr>
<td>&ndash;experimental-cluster-signing-duration</td>
<td>指定 TLS Bootstrap 证书的有效期；</td>
</tr>
<tr>
<td>&ndash;root-ca-file</td>
<td>放置到容器 ServiceAccount 中的 CA 证书，用来对 kube-apiserver 的证书进行校验；</td>
</tr>
<tr>
<td>&ndash;service-account-private-key-file</td>
<td>签名 ServiceAccount 中 Token 的私钥文件，必须和 kube-apiserver 的 <code>--service-account-key-file</code> 指定的公钥文件配对使用；</td>
</tr>
<tr>
<td>-service-cluster-ip-range</td>
<td>指定 Service Cluster IP 网段，必须和 kube-apiserver 中的同名参数一致；</td>
</tr>
<tr>
<td>&ndash;leader-elect=true</td>
<td>集群运行模式，启用选举功能；被选为 leader 的节点负责处理工作，其它节点为阻塞状态</td>
</tr>
<tr>
<td>&ndash;controllers=*,bootstrapsigner,tokencleaner</td>
<td>启用的控制器列表，tokencleaner 用于自动清理过期的 Bootstrap token</td>
</tr>
<tr>
<td>&ndash;horizontal-pod-autoscaler-*</td>
<td>custom metrics 相关参数，支持 autoscaling/v2alpha1；</td>
</tr>
<tr>
<td>-tls-cert-file<code>、</code>&ndash;tls-private-key-file</td>
<td>使用 https 输出 metrics 时使用的 Server 证书和秘钥；</td>
</tr>
<tr>
<td>&ndash;use-service-account-credentials=true</td>
<td>kube-controller-manager 中各 controller 使用 serviceaccount 访问 kube-apiserver；</td>
</tr>
</tbody>
</table>
<h4 id="为各节点创建和分发-kube-controller-mananger-systemd-unit-文件">为各节点创建和分发 kube-controller-mananger systemd unit 文件</h4>
<p>替换相应的变量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i &lt; 3<span class="p">;</span> i++ <span class="o">))</span>
  <span class="k">do</span>
    sed -e <span class="s2">&#34;s/##NODE_NAME##/</span><span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[i]</span><span class="si">}</span><span class="s2">/&#34;</span> -e <span class="s2">&#34;s/##NODE_IP##/</span><span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[i]</span><span class="si">}</span><span class="s2">/&#34;</span> kube-controller-manager.service.template &gt; kube-controller-manager-<span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[i]</span><span class="si">}</span>.service 
  <span class="k">done</span>
ls kube-controller-manager*.service
</code></pre></td></tr></table>
</div>
</div><p>分发至各个节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kube-controller-manager-<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>.service root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/systemd/system/kube-controller-manager.service
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="启动服务并检查">启动服务并检查</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;mkdir -p </span><span class="si">${</span><span class="nv">K8S_DIR</span><span class="si">}</span><span class="s2">/kube-controller-manager&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl daemon-reload &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl restart kube-controller-manager&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl status kube-controller-manager|grep Active&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="查看输出的metrics">查看输出的metrics</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">curl -s --cacert /opt/k8s/work/ca.pem --cert /opt/k8s/work/admin.pem --key /opt/k8s/work/admin-key.pem https://192.168.7.200:10252/metrics <span class="p">|</span>head
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># HELP apiserver_audit_event_total [ALPHA] Counter of audit events generated and sent to the audit backend.</span>
<span class="c1"># TYPE apiserver_audit_event_total counter</span>
apiserver_audit_event_total <span class="m">0</span>
<span class="c1"># HELP apiserver_audit_requests_rejected_total [ALPHA] Counter of apiserver requests rejected due to an error in audit logging backend.</span>
<span class="c1"># TYPE apiserver_audit_requests_rejected_total counter</span>
apiserver_audit_requests_rejected_total <span class="m">0</span>
<span class="c1"># HELP apiserver_client_certificate_expiration_seconds [ALPHA] Distribution of the remaining lifetime on the certificate used to authenticate a request.</span>
<span class="c1"># TYPE apiserver_client_certificate_expiration_seconds histogram</span>
apiserver_client_certificate_expiration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">&#34;0&#34;</span><span class="o">}</span> <span class="m">0</span>
apiserver_client_certificate_expiration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">&#34;1800&#34;</span><span class="o">}</span> <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="查看-leader-节点">查看 leader 节点</h4>
<ul>
<li>通过如下可以看出 k8s-node01 为当前 leader节点</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get endpoints kube-controller-manager --namespace<span class="o">=</span>kube-system  -o yaml
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">apiVersion: v1
kind: Endpoints
metadata:
  annotations:
    control-plane.alpha.kubernetes.io/leader: <span class="s1">&#39;{&#34;holderIdentity&#34;:&#34;k8s-node01_55929c1a-edbc-4a95-b406-09164b6cb257&#34;,&#34;leaseDurationSeconds&#34;:15,&#34;acquireTime&#34;:&#34;2020-08-14T03:38:41Z&#34;,&#34;renewTime&#34;:&#34;2020-08-14T03:40:01Z&#34;,&#34;leaderTransitions&#34;:0}&#39;</span>
  creationTimestamp: <span class="s2">&#34;2020-08-14T03:38:41Z&#34;</span>
  name: kube-controller-manager
  namespace: kube-system
  resourceVersion: <span class="s2">&#34;709&#34;</span>
  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager
  uid: cbc9cbfe-edf2-40a3-8316-605f2124b356
</code></pre></td></tr></table>
</div>
</div><h3 id="kube-scheduler-部署">kube-scheduler 部署</h3>
<h4 id="创建-kube-scheduler-证书和私钥">创建 kube-scheduler 证书和私钥</h4>
<ul>
<li>hosts 列表包含<strong>所有</strong> kube-scheduler 节点 IP；</li>
<li>CN 和 O 均为 <code>system:kube-scheduler</code>，kubernetes 内置的 ClusterRoleBindings <code>system:kube-scheduler</code> 将赋予 kube-scheduler 工作所需的权限；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cat &gt; kube-scheduler-csr.json <span class="s">&lt;&lt;EOF
</span><span class="s">{
</span><span class="s">    &#34;CN&#34;: &#34;system:kube-scheduler&#34;,
</span><span class="s">    &#34;hosts&#34;: [
</span><span class="s">      &#34;127.0.0.1&#34;,
</span><span class="s">      &#34;192.168.7.200&#34;,
</span><span class="s">      &#34;192.168.7.201&#34;,
</span><span class="s">      &#34;192.168.7.202&#34;
</span><span class="s">    ],
</span><span class="s">    &#34;key&#34;: {
</span><span class="s">        &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">        &#34;size&#34;: 2048
</span><span class="s">    },
</span><span class="s">    &#34;names&#34;: [
</span><span class="s">      {
</span><span class="s">        &#34;C&#34;: &#34;CN&#34;,
</span><span class="s">        &#34;ST&#34;: &#34;BeiJing&#34;,
</span><span class="s">        &#34;L&#34;: &#34;BeiJing&#34;,
</span><span class="s">        &#34;O&#34;: &#34;system:kube-scheduler&#34;,
</span><span class="s">        &#34;OU&#34;: &#34;opsnull&#34;
</span><span class="s">      }
</span><span class="s">    ]
</span><span class="s">}
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>生成并分发</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cfssl gencert -ca<span class="o">=</span>/opt/k8s/work/ca.pem <span class="se">\
</span><span class="se"></span>  -ca-key<span class="o">=</span>/opt/k8s/work/ca-key.pem <span class="se">\
</span><span class="se"></span>  -config<span class="o">=</span>/opt/k8s/work/ca-config.json <span class="se">\
</span><span class="se"></span>  -profile<span class="o">=</span>kubernetes kube-scheduler-csr.json <span class="p">|</span> cfssljson -bare kube-scheduler
ls kube-scheduler*pem
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kube-scheduler*.pem root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/kubernetes/cert/
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建和分发-kubeconfig-文件">创建和分发 kubeconfig 文件</h4>
<p>kube-scheduler 使用 kubeconfig 文件访问 apiserver，该文件提供了 apiserver 地址、嵌入的 CA 证书和 kube-scheduler 证书：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
kubectl config set-cluster kubernetes <span class="se">\
</span><span class="se"></span>  --certificate-authority<span class="o">=</span>/opt/k8s/work/ca.pem <span class="se">\
</span><span class="se"></span>  --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --server<span class="o">=</span><span class="s2">&#34;https://##NODE_IP##:6443&#34;</span> <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-scheduler.kubeconfig

kubectl config set-credentials system:kube-scheduler <span class="se">\
</span><span class="se"></span>  --client-certificate<span class="o">=</span>kube-scheduler.pem <span class="se">\
</span><span class="se"></span>  --client-key<span class="o">=</span>kube-scheduler-key.pem <span class="se">\
</span><span class="se"></span>  --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-scheduler.kubeconfig

kubectl config set-context system:kube-scheduler <span class="se">\
</span><span class="se"></span>  --cluster<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>  --user<span class="o">=</span>system:kube-scheduler <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-scheduler.kubeconfig

kubectl config use-context system:kube-scheduler --kubeconfig<span class="o">=</span>kube-scheduler.kubeconfig
</code></pre></td></tr></table>
</div>
</div><p>分发至各个master节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    sed -e <span class="s2">&#34;s/##NODE_IP##/</span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">/&#34;</span> kube-scheduler.kubeconfig &gt; kube-scheduler-<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>.kubeconfig
    scp kube-scheduler-<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>.kubeconfig root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/kubernetes/kube-scheduler.kubeconfig
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建-kube-scheduler-配置文件">创建 kube-scheduler 配置文件</h4>
<ul>
<li><code>--kubeconfig</code>：指定 kubeconfig 文件路径，kube-scheduler 使用它连接和验证 kube-apiserver；</li>
<li><code>--leader-elect=true</code>：集群运行模式，启用选举功能；被选为 leader 的节点负责处理工作，其它节点为阻塞状态；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cat &gt;kube-scheduler.yaml.template <span class="s">&lt;&lt;EOF
</span><span class="s">apiVersion: kubescheduler.config.k8s.io/v1alpha1
</span><span class="s">kind: KubeSchedulerConfiguration
</span><span class="s">bindTimeoutSeconds: 600
</span><span class="s">clientConnection:
</span><span class="s">  burst: 200
</span><span class="s">  kubeconfig: &#34;/etc/kubernetes/kube-scheduler.kubeconfig&#34;
</span><span class="s">  qps: 100
</span><span class="s">enableContentionProfiling: false
</span><span class="s">enableProfiling: true
</span><span class="s">hardPodAffinitySymmetricWeight: 1
</span><span class="s">healthzBindAddress: ##NODE_IP##:10251
</span><span class="s">leaderElection:
</span><span class="s">  leaderElect: true
</span><span class="s">metricsBindAddress: ##NODE_IP##:10251
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>替换模板文件中的变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i &lt; 3<span class="p">;</span> i++ <span class="o">))</span>
  <span class="k">do</span>
    sed -e <span class="s2">&#34;s/##NODE_NAME##/</span><span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[i]</span><span class="si">}</span><span class="s2">/&#34;</span> -e <span class="s2">&#34;s/##NODE_IP##/</span><span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[i]</span><span class="si">}</span><span class="s2">/&#34;</span> kube-scheduler.yaml.template &gt; kube-scheduler-<span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[i]</span><span class="si">}</span>.yaml
  <span class="k">done</span>
ls kube-scheduler*.yaml
</code></pre></td></tr></table>
</div>
</div><p>分发至各个master节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kube-scheduler-<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>.yaml root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/kubernetes/kube-scheduler.yaml
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建-kube-scheduler-systemd-unit-模板文件">创建 kube-scheduler systemd unit 模板文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
cat &gt; kube-scheduler.service.template <span class="s">&lt;&lt;EOF
</span><span class="s">[Unit]
</span><span class="s">Description=Kubernetes Scheduler
</span><span class="s">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span><span class="s">
</span><span class="s">[Service]
</span><span class="s">WorkingDirectory=${K8S_DIR}/kube-scheduler
</span><span class="s">ExecStart=/opt/k8s/bin/kube-scheduler \\
</span><span class="s">  --config=/etc/kubernetes/kube-scheduler.yaml \\
</span><span class="s">  --bind-address=##NODE_IP## \\
</span><span class="s">  --secure-port=10259 \\
</span><span class="s">  --port=0 \\
</span><span class="s">  --tls-cert-file=/etc/kubernetes/cert/kube-scheduler.pem \\
</span><span class="s">  --tls-private-key-file=/etc/kubernetes/cert/kube-scheduler-key.pem \\
</span><span class="s">  --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\
</span><span class="s">  --client-ca-file=/etc/kubernetes/cert/ca.pem \\
</span><span class="s">  --requestheader-allowed-names=&#34;&#34; \\
</span><span class="s">  --requestheader-client-ca-file=/etc/kubernetes/cert/ca.pem \\
</span><span class="s">  --requestheader-extra-headers-prefix=&#34;X-Remote-Extra-&#34; \\
</span><span class="s">  --requestheader-group-headers=X-Remote-Group \\
</span><span class="s">  --requestheader-username-headers=X-Remote-User \\
</span><span class="s">  --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\
</span><span class="s">  --logtostderr=true \\
</span><span class="s">  --v=2
</span><span class="s">Restart=always
</span><span class="s">RestartSec=5
</span><span class="s">StartLimitInterval=0
</span><span class="s">
</span><span class="s">[Install]
</span><span class="s">WantedBy=multi-user.target
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="为各节点创建和分发-kube-scheduler-systemd-unit-文件">为各节点创建和分发 kube-scheduler systemd unit 文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i &lt; 3<span class="p">;</span> i++ <span class="o">))</span>
  <span class="k">do</span>
    sed -e <span class="s2">&#34;s/##NODE_NAME##/</span><span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[i]</span><span class="si">}</span><span class="s2">/&#34;</span> -e <span class="s2">&#34;s/##NODE_IP##/</span><span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[i]</span><span class="si">}</span><span class="s2">/&#34;</span> kube-scheduler.service.template &gt; kube-scheduler-<span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[i]</span><span class="si">}</span>.service 
  <span class="k">done</span>
ls kube-scheduler*.service
</code></pre></td></tr></table>
</div>
</div><p>分发至各个master节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kube-scheduler-<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>.service root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/systemd/system/kube-scheduler.service
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="启动-kube-schduler-服务">启动 kube-schduler 服务</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;mkdir -p </span><span class="si">${</span><span class="nv">K8S_DIR</span><span class="si">}</span><span class="s2">/kube-scheduler&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl restart kube-scheduler&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="检查服务状态">检查服务状态</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl status kube-scheduler|grep Active&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="查看输出的metrics-1">查看输出的metrics</h4>
<p>注意：以下命令在 kube-scheduler 节点上执行。</p>
<p>kube-scheduler 监听 10251 和 10259 端口：</p>
<ul>
<li>10251：接收 http 请求，非安全端口，不需要认证授权；</li>
<li>10259：接收 https 请求，安全端口，需要认证授权；</li>
</ul>
<p>两个接口都对外提供 <code>/metrics</code> 和 <code>/healthz</code> 的访问。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">netstat -lnpt <span class="p">|</span>grep kube-sch
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">tcp        <span class="m">0</span>      <span class="m">0</span> 192.168.7.200:10251     0.0.0.0:*               LISTEN      1219/kube-scheduler 
tcp        <span class="m">0</span>      <span class="m">0</span> 192.168.7.200:10259     0.0.0.0:*               LISTEN      1219/kube-scheduler 
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">curl -s http://192.168.7.200:10251/metrics <span class="p">|</span>head
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># HELP apiserver_audit_event_total [ALPHA] Counter of audit events generated and sent to the audit backend.</span>
<span class="c1"># TYPE apiserver_audit_event_total counter</span>
apiserver_audit_event_total <span class="m">0</span>
<span class="c1"># HELP apiserver_audit_requests_rejected_total [ALPHA] Counter of apiserver requests rejected due to an error in audit logging backend.</span>
<span class="c1"># TYPE apiserver_audit_requests_rejected_total counter</span>
apiserver_audit_requests_rejected_total <span class="m">0</span>
<span class="c1"># HELP apiserver_client_certificate_expiration_seconds [ALPHA] Distribution of the remaining lifetime on the certificate used to authenticate a request.</span>
<span class="c1"># TYPE apiserver_client_certificate_expiration_seconds histogram</span>
apiserver_client_certificate_expiration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">&#34;0&#34;</span><span class="o">}</span> <span class="m">0</span>
apiserver_client_certificate_expiration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">&#34;1800&#34;</span><span class="o">}</span> <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">curl -s --cacert /opt/k8s/work/ca.pem --cert /opt/k8s/work/admin.pem --key /opt/k8s/work/admin-key.pem https://192.168.7.200:10259/metrics <span class="p">|</span>head
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># HELP apiserver_audit_event_total [ALPHA] Counter of audit events generated and sent to the audit backend.</span>
<span class="c1"># TYPE apiserver_audit_event_total counter</span>
apiserver_audit_event_total <span class="m">0</span>
<span class="c1"># HELP apiserver_audit_requests_rejected_total [ALPHA] Counter of apiserver requests rejected due to an error in audit logging backend.</span>
<span class="c1"># TYPE apiserver_audit_requests_rejected_total counter</span>
apiserver_audit_requests_rejected_total <span class="m">0</span>
<span class="c1"># HELP apiserver_client_certificate_expiration_seconds [ALPHA] Distribution of the remaining lifetime on the certificate used to authenticate a request.</span>
<span class="c1"># TYPE apiserver_client_certificate_expiration_seconds histogram</span>
apiserver_client_certificate_expiration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">&#34;0&#34;</span><span class="o">}</span> <span class="m">0</span>
apiserver_client_certificate_expiration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">&#34;1800&#34;</span><span class="o">}</span> <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="查看当前-leader">查看当前 leader</h4>
<ul>
<li>可以看到当前 leader 为 k8s-node01 节点</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get endpoints kube-scheduler --namespace<span class="o">=</span>kube-system  -o yaml
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">apiVersion: v1
kind: Endpoints
metadata:
  annotations:
    control-plane.alpha.kubernetes.io/leader: <span class="s1">&#39;{&#34;holderIdentity&#34;:&#34;k8s-node01_dc1295e0-789e-4d17-82cd-0ccea2350ce2&#34;,&#34;leaseDurationSeconds&#34;:15,&#34;acquireTime&#34;:&#34;2020-08-14T03:50:30Z&#34;,&#34;renewTime&#34;:&#34;2020-08-14T03:51:54Z&#34;,&#34;leaderTransitions&#34;:0}&#39;</span>
  creationTimestamp: <span class="s2">&#34;2020-08-14T03:50:30Z&#34;</span>
  name: kube-scheduler
  namespace: kube-system
  resourceVersion: <span class="s2">&#34;1323&#34;</span>
  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-scheduler
  uid: 1473e241-626a-48aa-8da4-421e4796ad3e

</code></pre></td></tr></table>
</div>
</div><h2 id="work节点部署">work节点部署</h2>
<p>work节点部署包含以下组件</p>
<ul>
<li>containerd</li>
<li>kubelet</li>
<li>kube-proxy</li>
<li>calico</li>
<li>kube-nginx</li>
</ul>
<p>依赖安装</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;yum install -y epel-release&#34;</span> <span class="p">&amp;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;yum install -y chrony conntrack ipvsadm ipset jq iptables curl sysstat libseccomp wget socat git&#34;</span> <span class="p">&amp;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="api-server-高可用">api server 高可用</h3>
<p>使用 nginx 4 层透明代理功能实现 Kubernetes worker 节点组件高可用访问 kube-apiserver 集群</p>
<ul>
<li>控制节点的 kube-controller-manager、kube-scheduler 是多实例部署且连接本机的 kube-apiserver，所以只要有一个实例正常，就可以保证高可用；</li>
<li>集群内的 Pod 使用 K8S 服务域名 kubernetes 访问 kube-apiserver， kube-dns 会自动解析出多个 kube-apiserver 节点的 IP，所以也是高可用的；</li>
<li>在每个节点起一个 nginx 进程，后端对接多个 apiserver 实例，nginx 对它们做健康检查和负载均衡；</li>
<li>kubelet、kube-proxy 通过本地的 nginx（监听 127.0.0.1）访问 kube-apiserver，从而实现 kube-apiserver 的高可用；</li>
</ul>
<h4 id="下载编译安装-nginx">下载编译安装 Nginx</h4>
<p>下载源码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
wget http://nginx.org/download/nginx-1.15.3.tar.gz
tar -xzvf nginx-1.15.3.tar.gz
</code></pre></td></tr></table>
</div>
</div><p>配置编译参数</p>
<ul>
<li><code>--with-stream</code>：开启 4 层透明转发(TCP Proxy)功能；</li>
<li><code>--without-xxx</code>：关闭所有其他功能，这样生成的动态链接二进制程序依赖最小；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work/nginx-1.15.3
mkdir nginx-prefix
yum install -y gcc make
./configure --with-stream --without-http --prefix<span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/nginx-prefix --without-http_uwsgi_module --without-http_scgi_module --without-http_fastcgi_module
</code></pre></td></tr></table>
</div>
</div><p>安装</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work/nginx-1.15.3
make <span class="o">&amp;&amp;</span> make install
</code></pre></td></tr></table>
</div>
</div><p>验证编译的nginx</p>
<ul>
<li>正常输出版本</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work/nginx-1.15.3
./nginx-prefix/sbin/nginx -v
</code></pre></td></tr></table>
</div>
</div><h4 id="安装部署">安装部署</h4>
<p>创建目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;mkdir -p /opt/k8s/kube-nginx/{conf,logs,sbin}&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>分发二进制文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;mkdir -p /opt/k8s/kube-nginx/{conf,logs,sbin}&#34;</span>
    scp /opt/k8s/work/nginx-1.15.3/nginx-prefix/sbin/nginx  root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/opt/k8s/kube-nginx/sbin/kube-nginx
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;chmod a+x /opt/k8s/kube-nginx/sbin/*&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>配置 nginx，开启4层透明转发功能</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cat &gt; kube-nginx.conf <span class="s">&lt;&lt; \EOF
</span><span class="s">worker_processes 1;
</span><span class="s">
</span><span class="s">events {
</span><span class="s">    worker_connections  1024;
</span><span class="s">}
</span><span class="s">
</span><span class="s">stream {
</span><span class="s">    upstream backend {
</span><span class="s">        hash $remote_addr consistent;
</span><span class="s">        server 192.168.7.200:6443        max_fails=3 fail_timeout=30s;
</span><span class="s">        server 192.168.7.201:6443        max_fails=3 fail_timeout=30s;
</span><span class="s">        server 192.168.7.202:6443        max_fails=3 fail_timeout=30s;
</span><span class="s">    }
</span><span class="s">
</span><span class="s">    server {
</span><span class="s">        listen 127.0.0.1:8443;
</span><span class="s">        proxy_connect_timeout 1s;
</span><span class="s">        proxy_pass backend;
</span><span class="s">    }
</span><span class="s">}
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>分发配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kube-nginx.conf  root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/opt/k8s/kube-nginx/conf/kube-nginx.conf
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="配置-systemd-unit-文件-与-启动服务">配置 systemd unit 文件 与 启动服务</h4>
<p>配置 nginx systemd unit 文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cat &gt; kube-nginx.service <span class="s">&lt;&lt;EOF
</span><span class="s">[Unit]
</span><span class="s">Description=kube-apiserver nginx proxy
</span><span class="s">After=network.target
</span><span class="s">After=network-online.target
</span><span class="s">Wants=network-online.target
</span><span class="s">
</span><span class="s">[Service]
</span><span class="s">Type=forking
</span><span class="s">ExecStartPre=/opt/k8s/kube-nginx/sbin/kube-nginx -c /opt/k8s/kube-nginx/conf/kube-nginx.conf -p /opt/k8s/kube-nginx -t
</span><span class="s">ExecStart=/opt/k8s/kube-nginx/sbin/kube-nginx -c /opt/k8s/kube-nginx/conf/kube-nginx.conf -p /opt/k8s/kube-nginx
</span><span class="s">ExecReload=/opt/k8s/kube-nginx/sbin/kube-nginx -c /opt/k8s/kube-nginx/conf/kube-nginx.conf -p /opt/k8s/kube-nginx -s reload
</span><span class="s">PrivateTmp=true
</span><span class="s">Restart=always
</span><span class="s">RestartSec=5
</span><span class="s">StartLimitInterval=0
</span><span class="s">LimitNOFILE=65536
</span><span class="s">
</span><span class="s">[Install]
</span><span class="s">WantedBy=multi-user.target
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>分发配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kube-nginx.service  root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/systemd/system/
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>启动服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl daemon-reload &amp;&amp; systemctl enable kube-nginx &amp;&amp; systemctl restart kube-nginx&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="验证-kube-nginx">验证 kube-nginx</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl status kube-nginx |grep &#39;Active:&#39;&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="部署-containerd">部署 containerd</h3>
<p>containerd 实现了 kubernetes 的 Container Runtime Interface (CRI) 接口，提供容器运行时核心功能，如镜像管理、容器管理等，相比 dockerd 更加简单、健壮和可移植。</p>
<h4 id="下载分发二进制">下载分发二进制</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.17.0/crictl-v1.17.0-linux-amd64.tar.gz <span class="se">\
</span><span class="se"></span>  https://github.com/opencontainers/runc/releases/download/v1.0.0-rc10/runc.amd64 <span class="se">\
</span><span class="se"></span>  https://github.com/containernetworking/plugins/releases/download/v0.8.5/cni-plugins-linux-amd64-v0.8.5.tgz <span class="se">\
</span><span class="se"></span>  https://github.com/containerd/containerd/releases/download/v1.3.3/containerd-1.3.3.linux-amd64.tar.gz 
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
mkdir containerd
tar -xvf containerd-1.3.3.linux-amd64.tar.gz -C containerd
tar -xvf crictl-v1.17.0-linux-amd64.tar.gz

mkdir cni-plugins
tar -xvf cni-plugins-linux-amd64-v0.8.5.tgz -C cni-plugins

mv runc.amd64 runc
</code></pre></td></tr></table>
</div>
</div><p>分发到各个节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp containerd/bin/*  crictl  cni-plugins/*  runc  root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/opt/k8s/bin
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;chmod a+x /opt/k8s/bin/* &amp;&amp; mkdir -p /etc/cni/net.d&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建分发-containerd-配置文件">创建分发 containerd 配置文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
cat <span class="s">&lt;&lt; EOF | sudo tee containerd-config.toml
</span><span class="s">version = 2
</span><span class="s">root = &#34;${CONTAINERD_DIR}/root&#34;
</span><span class="s">state = &#34;${CONTAINERD_DIR}/state&#34;
</span><span class="s">
</span><span class="s">[plugins]
</span><span class="s">  [plugins.&#34;io.containerd.grpc.v1.cri&#34;]
</span><span class="s">    sandbox_image = &#34;registry.cn-beijing.aliyuncs.com/images_k8s/pause-amd64:3.1&#34;
</span><span class="s">    [plugins.&#34;io.containerd.grpc.v1.cri&#34;.cni]
</span><span class="s">      bin_dir = &#34;/opt/k8s/bin&#34;
</span><span class="s">      conf_dir = &#34;/etc/cni/net.d&#34;
</span><span class="s">  [plugins.&#34;io.containerd.runtime.v1.linux&#34;]
</span><span class="s">    shim = &#34;containerd-shim&#34;
</span><span class="s">    runtime = &#34;runc&#34;
</span><span class="s">    runtime_root = &#34;&#34;
</span><span class="s">    no_shim = false
</span><span class="s">    shim_debug = false
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>分发配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;mkdir -p /etc/containerd/ </span><span class="si">${</span><span class="nv">CONTAINERD_DIR</span><span class="si">}</span><span class="s2">/{root,state}&#34;</span>
    scp containerd-config.toml root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/containerd/config.toml
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建-分发-containerd-systemd-unit-配置文件">创建 分发 containerd systemd unit 配置文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cat <span class="s">&lt;&lt;EOF | sudo tee containerd.service
</span><span class="s">[Unit]
</span><span class="s">Description=containerd container runtime
</span><span class="s">Documentation=https://containerd.io
</span><span class="s">After=network.target
</span><span class="s">
</span><span class="s">[Service]
</span><span class="s">Environment=&#34;PATH=/opt/k8s/bin:/bin:/sbin:/usr/bin:/usr/sbin&#34;
</span><span class="s">ExecStartPre=/sbin/modprobe overlay
</span><span class="s">ExecStart=/opt/k8s/bin/containerd
</span><span class="s">Restart=always
</span><span class="s">RestartSec=5
</span><span class="s">Delegate=yes
</span><span class="s">KillMode=process
</span><span class="s">OOMScoreAdjust=-999
</span><span class="s">LimitNOFILE=1048576
</span><span class="s">LimitNPROC=infinity
</span><span class="s">LimitCORE=infinity
</span><span class="s">
</span><span class="s">[Install]
</span><span class="s">WantedBy=multi-user.target
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>分发配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp containerd.service root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/systemd/system
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl enable containerd &amp;&amp; systemctl restart containerd&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建分发-crictl-配置文件">创建分发 crictl 配置文件</h4>
<p>crictl 是兼容 CRI 容器运行时的命令行工具，提供类似于 docker 命令的功能</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cat <span class="s">&lt;&lt; EOF | sudo tee crictl.yaml
</span><span class="s">runtime-endpoint: unix:///run/containerd/containerd.sock
</span><span class="s">image-endpoint: unix:///run/containerd/containerd.sock
</span><span class="s">timeout: 10
</span><span class="s">debug: false
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>分发到 worker 节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    scp crictl.yaml root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/crictl.yaml
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="部署-kubelet">部署 kubelet</h3>
<p>kubelet 运行在每个 worker 节点上，接收 kube-apiserver 发送的请求，管理 Pod 容器，执行交互式命令，如 exec、run、logs 等。</p>
<p>kubelet 启动时自动向 kube-apiserver 注册节点信息，内置的 cadvisor 统计和监控节点的资源使用情况。</p>
<p>为确保安全，部署时关闭了 kubelet 的非安全 http 端口，对请求进行认证和授权，拒绝未授权的访问(如 apiserver、heapster 的请求)。</p>
<h4 id="下载分发">下载分发</h4>
<ul>
<li>在 master 节点部署的时候，已经分发到各个节点了</li>
</ul>
<h4 id="创建-kubelet-bootstrap-kubeconfig-文件">创建 kubelet bootstrap kubeconfig 文件</h4>
<ul>
<li>向 kubeconfig 写入的是 token，bootstrap 结束后 kube-controller-manager 为 kubelet 创建 client 和 server 证书；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_name in <span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_name</span><span class="si">}</span><span class="s2">&#34;</span>

    <span class="c1"># 创建 token</span>
    <span class="nb">export</span> <span class="nv">BOOTSTRAP_TOKEN</span><span class="o">=</span><span class="k">$(</span>kubeadm token create <span class="se">\
</span><span class="se"></span>      --description kubelet-bootstrap-token <span class="se">\
</span><span class="se"></span>      --groups system:bootstrappers:<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>      --kubeconfig ~/.kube/config<span class="k">)</span>

    <span class="c1"># 设置集群参数</span>
    kubectl config set-cluster kubernetes <span class="se">\
</span><span class="se"></span>      --certificate-authority<span class="o">=</span>/etc/kubernetes/cert/ca.pem <span class="se">\
</span><span class="se"></span>      --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>      --server<span class="o">=</span><span class="si">${</span><span class="nv">KUBE_APISERVER</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>      --kubeconfig<span class="o">=</span>kubelet-bootstrap-<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span>.kubeconfig

    <span class="c1"># 设置客户端认证参数</span>
    kubectl config set-credentials kubelet-bootstrap <span class="se">\
</span><span class="se"></span>      --token<span class="o">=</span><span class="si">${</span><span class="nv">BOOTSTRAP_TOKEN</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>      --kubeconfig<span class="o">=</span>kubelet-bootstrap-<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span>.kubeconfig

    <span class="c1"># 设置上下文参数</span>
    kubectl config set-context default <span class="se">\
</span><span class="se"></span>      --cluster<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>      --user<span class="o">=</span>kubelet-bootstrap <span class="se">\
</span><span class="se"></span>      --kubeconfig<span class="o">=</span>kubelet-bootstrap-<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span>.kubeconfig

    <span class="c1"># 设置默认上下文</span>
    kubectl config use-context default --kubeconfig<span class="o">=</span>kubelet-bootstrap-<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span>.kubeconfig
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>查看 kubeadm 为各节点创建的 token</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubeadm token list --kubeconfig ~/.kube/config
</code></pre></td></tr></table>
</div>
</div><ul>
<li>token 的有效期为 24h，超期后不能用来进行 boostrap kubelet，且会被 kube-controller-manager 的 tokencleaner 清理；</li>
<li>kube-apiserver 接收 kubelet 的 bootstrap token 后，将请求的 user 设置为 <code>system:bootstrap:&lt;Token ID&gt;</code>，group 设置为 <code>system:bootstrappers</code>，后续将为这个 group 设置 ClusterRoleBinding；</li>
</ul>
<h4 id="分发-bootstrap-kubeconfig-文件到所有-worker-节点">分发 bootstrap kubeconfig 文件到所有 worker 节点</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_name in <span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_name</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kubelet-bootstrap-<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span>.kubeconfig root@<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span>:/etc/kubernetes/kubelet-bootstrap.kubeconfig
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建分发kubelet-参数配置文件">创建分发kubelet 参数配置文件</h4>
<p>从 v1.10 开始，部分 kubelet 参数需在<strong>配置文件</strong>中配置，<code>kubelet --help</code> 会提示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">DEPRECATED: This parameter should be <span class="nb">set</span> via the config file specified by the Kubelet<span class="err">&#39;</span>s --config flag
</code></pre></td></tr></table>
</div>
</div><p>创建 kubelet 参数配置文件模板</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
cat &gt; kubelet-config.yaml.template <span class="s">&lt;&lt;EOF
</span><span class="s">kind: KubeletConfiguration
</span><span class="s">apiVersion: kubelet.config.k8s.io/v1beta1
</span><span class="s">address: &#34;##NODE_IP##&#34;
</span><span class="s">staticPodPath: &#34;&#34;
</span><span class="s">syncFrequency: 1m
</span><span class="s">fileCheckFrequency: 20s
</span><span class="s">httpCheckFrequency: 20s
</span><span class="s">staticPodURL: &#34;&#34;
</span><span class="s">port: 10250
</span><span class="s">readOnlyPort: 0
</span><span class="s">rotateCertificates: true
</span><span class="s">serverTLSBootstrap: true
</span><span class="s">authentication:
</span><span class="s">  anonymous:
</span><span class="s">    enabled: false
</span><span class="s">  webhook:
</span><span class="s">    enabled: true
</span><span class="s">  x509:
</span><span class="s">    clientCAFile: &#34;/etc/kubernetes/cert/ca.pem&#34;
</span><span class="s">authorization:
</span><span class="s">  mode: Webhook
</span><span class="s">registryPullQPS: 0
</span><span class="s">registryBurst: 20
</span><span class="s">eventRecordQPS: 0
</span><span class="s">eventBurst: 20
</span><span class="s">enableDebuggingHandlers: true
</span><span class="s">enableContentionProfiling: true
</span><span class="s">healthzPort: 10248
</span><span class="s">healthzBindAddress: &#34;##NODE_IP##&#34;
</span><span class="s">clusterDomain: &#34;${CLUSTER_DNS_DOMAIN}&#34;
</span><span class="s">clusterDNS:
</span><span class="s">  - &#34;${CLUSTER_DNS_SVC_IP}&#34;
</span><span class="s">nodeStatusUpdateFrequency: 10s
</span><span class="s">nodeStatusReportFrequency: 1m
</span><span class="s">imageMinimumGCAge: 2m
</span><span class="s">imageGCHighThresholdPercent: 85
</span><span class="s">imageGCLowThresholdPercent: 80
</span><span class="s">volumeStatsAggPeriod: 1m
</span><span class="s">kubeletCgroups: &#34;&#34;
</span><span class="s">systemCgroups: &#34;&#34;
</span><span class="s">cgroupRoot: &#34;&#34;
</span><span class="s">cgroupsPerQOS: true
</span><span class="s">cgroupDriver: cgroupfs
</span><span class="s">runtimeRequestTimeout: 10m
</span><span class="s">hairpinMode: promiscuous-bridge
</span><span class="s">maxPods: 220
</span><span class="s">podCIDR: &#34;${CLUSTER_CIDR}&#34;
</span><span class="s">podPidsLimit: -1
</span><span class="s">resolvConf: /etc/resolv.conf
</span><span class="s">maxOpenFiles: 1000000
</span><span class="s">kubeAPIQPS: 1000
</span><span class="s">kubeAPIBurst: 2000
</span><span class="s">serializeImagePulls: false
</span><span class="s">evictionHard:
</span><span class="s">  memory.available:  &#34;100Mi&#34;
</span><span class="s">  nodefs.available:  &#34;10%&#34;
</span><span class="s">  nodefs.inodesFree: &#34;5%&#34;
</span><span class="s">  imagefs.available: &#34;15%&#34;
</span><span class="s">evictionSoft: {}
</span><span class="s">enableControllerAttachDetach: true
</span><span class="s">failSwapOn: true
</span><span class="s">containerLogMaxSize: 20Mi
</span><span class="s">containerLogMaxFiles: 10
</span><span class="s">systemReserved: {}
</span><span class="s">kubeReserved: {}
</span><span class="s">systemReservedCgroup: &#34;&#34;
</span><span class="s">kubeReservedCgroup: &#34;&#34;
</span><span class="s">enforceNodeAllocatable: [&#34;pods&#34;]
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>address</td>
<td>kubelet 安全端口（https，10250）监听的地址，不能为 127.0.0.1，否则 kube-apiserver、heapster 等不能调用 kubelet 的 API；</td>
</tr>
<tr>
<td>readOnlyPort=0</td>
<td>关闭只读端口(默认 10255)，等效为未指定</td>
</tr>
<tr>
<td>authentication.anonymous.enabled</td>
<td>设置为 false，不允许匿名访问 10250 端口</td>
</tr>
<tr>
<td>authentication.x509.clientCAFile</td>
<td>指定签名客户端证书的 CA 证书，开启 HTTP 证书认证；</td>
</tr>
<tr>
<td>authentication.webhook.enabled=true</td>
<td>开启 HTTPs bearer token 认证；</td>
</tr>
<tr>
<td>authroization.mode=Webhook</td>
<td>kubelet 使用 SubjectAccessReview API 查询 kube-apiserver 某 user、group 是否具有操作资源的权限(RBAC)；</td>
</tr>
<tr>
<td>featureGates.RotateKubeletClientCertificate、featureGates.RotateKubeletServerCertificate</td>
<td>自动 rotate 证书，证书的有效期取决于 kube-controller-manager 的 &ndash;experimental-cluster-signing-duration 参数</td>
</tr>
</tbody>
</table>
<p>分发</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span> 
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    sed -e <span class="s2">&#34;s/##NODE_IP##/</span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">/&#34;</span> kubelet-config.yaml.template &gt; kubelet-config-<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>.yaml.template
    scp kubelet-config-<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>.yaml.template root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span>:/etc/kubernetes/kubelet-config.yaml
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建分发-kubelet-systemd-unit-文件">创建分发 kubelet systemd unit 文件</h4>
<ul>
<li>如果设置了 <code>--hostname-override</code> 选项，则 <code>kube-proxy</code> 也需要设置该选项，否则会出现找不到 Node 的情况；</li>
<li><code>--bootstrap-kubeconfig</code>：指向 bootstrap kubeconfig 文件，kubelet 使用该文件中的用户名和 token 向 kube-apiserver 发送 TLS Bootstrapping 请求；</li>
<li>K8S approve kubelet 的 csr 请求后，在 <code>--cert-dir</code> 目录创建证书和私钥文件，然后写入 <code>--kubeconfig</code> 文件；</li>
<li><code>--pod-infra-container-image</code> 不使用 redhat 的 <code>pod-infrastructure:latest</code> 镜像，它不能回收容器的僵尸；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
cat &gt; kubelet.service.template <span class="s">&lt;&lt;EOF
</span><span class="s">[Unit]
</span><span class="s">Description=Kubernetes Kubelet
</span><span class="s">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span><span class="s">After=containerd.service
</span><span class="s">Requires=containerd.service
</span><span class="s">
</span><span class="s">[Service]
</span><span class="s">WorkingDirectory=${K8S_DIR}/kubelet
</span><span class="s">ExecStart=/opt/k8s/bin/kubelet \\
</span><span class="s">  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\
</span><span class="s">  --cert-dir=/etc/kubernetes/cert \\
</span><span class="s">  --network-plugin=cni \\
</span><span class="s">  --cni-conf-dir=/etc/cni/net.d \\
</span><span class="s">  --container-runtime=remote \\
</span><span class="s">  --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \\
</span><span class="s">  --root-dir=${K8S_DIR}/kubelet \\
</span><span class="s">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\
</span><span class="s">  --config=/etc/kubernetes/kubelet-config.yaml \\
</span><span class="s">  --hostname-override=##NODE_NAME## \\
</span><span class="s">  --image-pull-progress-deadline=15m \\
</span><span class="s">  --volume-plugin-dir=${K8S_DIR}/kubelet/kubelet-plugins/volume/exec/ \\
</span><span class="s">  --logtostderr=true \\
</span><span class="s">  --v=2
</span><span class="s">Restart=always
</span><span class="s">RestartSec=5
</span><span class="s">StartLimitInterval=0
</span><span class="s">
</span><span class="s">[Install]
</span><span class="s">WantedBy=multi-user.target
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>分发</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_name in <span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span> 
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_name</span><span class="si">}</span><span class="s2">&#34;</span>
    sed -e <span class="s2">&#34;s/##NODE_NAME##/</span><span class="si">${</span><span class="nv">node_name</span><span class="si">}</span><span class="s2">/&#34;</span> kubelet.service.template &gt; kubelet-<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span>.service
    scp kubelet-<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span>.service root@<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span>:/etc/systemd/system/kubelet.service
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="授予-kube-apiserver-访问-kubelet-api-的权限">授予 kube-apiserver 访问 kubelet API 的权限</h4>
<p>在执行 kubectl exec、run、logs 等命令时，apiserver 会将请求转发到 kubelet 的 https 端口。这里定义 RBAC 规则，授权 apiserver 使用的证书（kubernetes.pem）用户名（CN：kuberntes-master）访问 kubelet API 的权限：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole<span class="o">=</span>system:kubelet-api-admin --user kubernetes-master
</code></pre></td></tr></table>
</div>
</div><h4 id="bootstrap-token-auth-和授予权限">Bootstrap Token Auth 和授予权限</h4>
<p>kubelet 启动时查找 <code>--kubeletconfig</code> 参数对应的文件是否存在，如果不存在则使用 <code>--bootstrap-kubeconfig</code> 指定的 kubeconfig 文件向 kube-apiserver 发送证书签名请求 (CSR)。</p>
<p>kube-apiserver 收到 CSR 请求后，对其中的 Token 进行认证，认证通过后将请求的 user 设置为 <code>system:bootstrap:&lt;Token ID&gt;</code>，group 设置为 <code>system:bootstrappers</code>，这一过程称为 <code>Bootstrap Token Auth</code>。</p>
<p>默认情况下，这个 user 和 group 没有创建 CSR 的权限，kubelet启动失败</p>
<p>创建一个 clusterrolebinding，将 group system:bootstrappers 和 clusterrole system:node-bootstrapper 绑定</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers
</code></pre></td></tr></table>
</div>
</div><h4 id="自动-approve-csr-请求生成-kubelet-client-证书">自动 approve CSR 请求，生成 kubelet client 证书</h4>
<p>kubelet 创建 CSR 请求后，下一步需要创建被 approve，有两种方式：</p>
<ul>
<li>kube-controller-manager 自动 aprrove；</li>
<li>手动使用命令 <code>kubectl certificate approve</code>；</li>
</ul>
<p>CSR 被 approve 后，kubelet 向 kube-controller-manager 请求创建 client 证书，kube-controller-manager 中的 <code>csrapproving</code> controller 使用 <code>SubjectAccessReview</code> API 来检查 kubelet 请求（对应的 group 是 system:bootstrappers）是否具有相应的权限。</p>
<p>创建三个 ClusterRoleBinding，分别授予 group system:bootstrappers 和 group system:nodes 进行 approve client、renew client、renew server 证书的权限</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cat &gt; csr-crb.yaml <span class="s">&lt;&lt;EOF
</span><span class="s"> # Approve all CSRs for the group &#34;system:bootstrappers&#34;
</span><span class="s"> kind: ClusterRoleBinding
</span><span class="s"> apiVersion: rbac.authorization.k8s.io/v1
</span><span class="s"> metadata:
</span><span class="s">   name: auto-approve-csrs-for-group
</span><span class="s"> subjects:
</span><span class="s"> - kind: Group
</span><span class="s">   name: system:bootstrappers
</span><span class="s">   apiGroup: rbac.authorization.k8s.io
</span><span class="s"> roleRef:
</span><span class="s">   kind: ClusterRole
</span><span class="s">   name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
</span><span class="s">   apiGroup: rbac.authorization.k8s.io
</span><span class="s">---
</span><span class="s"> # To let a node of the group &#34;system:nodes&#34; renew its own credentials
</span><span class="s"> kind: ClusterRoleBinding
</span><span class="s"> apiVersion: rbac.authorization.k8s.io/v1
</span><span class="s"> metadata:
</span><span class="s">   name: node-client-cert-renewal
</span><span class="s"> subjects:
</span><span class="s"> - kind: Group
</span><span class="s">   name: system:nodes
</span><span class="s">   apiGroup: rbac.authorization.k8s.io
</span><span class="s"> roleRef:
</span><span class="s">   kind: ClusterRole
</span><span class="s">   name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
</span><span class="s">   apiGroup: rbac.authorization.k8s.io
</span><span class="s">---
</span><span class="s"># A ClusterRole which instructs the CSR approver to approve a node requesting a
</span><span class="s"># serving cert matching its client cert.
</span><span class="s">kind: ClusterRole
</span><span class="s">apiVersion: rbac.authorization.k8s.io/v1
</span><span class="s">metadata:
</span><span class="s">  name: approve-node-server-renewal-csr
</span><span class="s">rules:
</span><span class="s">- apiGroups: [&#34;certificates.k8s.io&#34;]
</span><span class="s">  resources: [&#34;certificatesigningrequests/selfnodeserver&#34;]
</span><span class="s">  verbs: [&#34;create&#34;]
</span><span class="s">---
</span><span class="s"> # To let a node of the group &#34;system:nodes&#34; renew its own server credentials
</span><span class="s"> kind: ClusterRoleBinding
</span><span class="s"> apiVersion: rbac.authorization.k8s.io/v1
</span><span class="s"> metadata:
</span><span class="s">   name: node-server-cert-renewal
</span><span class="s"> subjects:
</span><span class="s"> - kind: Group
</span><span class="s">   name: system:nodes
</span><span class="s">   apiGroup: rbac.authorization.k8s.io
</span><span class="s"> roleRef:
</span><span class="s">   kind: ClusterRole
</span><span class="s">   name: approve-node-server-renewal-csr
</span><span class="s">   apiGroup: rbac.authorization.k8s.io
</span><span class="s">EOF</span>
kubectl apply -f csr-crb.yaml
</code></pre></td></tr></table>
</div>
</div><ul>
<li>auto-approve-csrs-for-group：自动 approve node 的第一次 CSR； 注意第一次 CSR 时，请求的 Group 为 system:bootstrappers；</li>
<li>node-client-cert-renewal：自动 approve node 后续过期的 client 证书，自动生成的证书 Group 为 system:nodes;</li>
<li>node-server-cert-renewal：自动 approve node 后续过期的 server 证书，自动生成的证书 Group 为 system:nodes;</li>
</ul>
<h4 id="启动-kubelet">启动 kubelet</h4>
<ul>
<li>启动服务前必须先创建工作目录；</li>
<li>关闭 swap 分区，否则 kubelet 会启动失败；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;mkdir -p </span><span class="si">${</span><span class="nv">K8S_DIR</span><span class="si">}</span><span class="s2">/kubelet/kubelet-plugins/volume/exec/&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;/usr/sbin/swapoff -a&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl restart kubelet&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>kubelet 启动后使用 &ndash;bootstrap-kubeconfig 向 kube-apiserver 发送 CSR 请求，当这个 CSR 被 approve 后，kube-controller-manager 为 kubelet 创建 TLS 客户端证书、私钥和 &ndash;kubeletconfig 文件。</p>
<p>注意：kube-controller-manager 需要配置 <code>--cluster-signing-cert-file</code> 和 <code>--cluster-signing-key-file</code> 参数，才会为 TLS Bootstrap 创建证书和私钥。</p>
<h4 id="查看-kubelet-情况">查看 kubelet 情况</h4>
<p>查看csr</p>
<ul>
<li>三个节点的 CSR 都被自动的 Approved；</li>
<li>会存在 Pending状态的 CSR，该 CSR 是用于创建 kubelet server 证书，需要手动 approved</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get csr
</code></pre></td></tr></table>
</div>
</div><p>查看 node</p>
<ul>
<li>可以看到三个 nodes 都已经注册，且是 Not Ready 状态， 安装网络插件后就会好了</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get nodes
</code></pre></td></tr></table>
</div>
</div><p>kube-controller-manager 为各 node 生成了 kubeconfig 文件和公私钥：</p>
<ul>
<li>没有自动生成 kubelet server 证书</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">ls -l /etc/kubernetes/kubelet.kubeconfig
ls -l /etc/kubernetes/cert/kubelet-client-*
</code></pre></td></tr></table>
</div>
</div><h4 id="手动-approve-server-cert-csr">手动 approve server cert csr</h4>
<p>由于安全性的考虑，CSR approving controllers 不会自动 approve kubelet server 证书签名请求，需要手动 approve：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get csr <span class="p">|</span> grep Pending <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> xargs kubectl certificate approve
</code></pre></td></tr></table>
</div>
</div><p>可以查看自动生成了 server 证书</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">ls -l /etc/kubernetes/cert/kubelet-*
</code></pre></td></tr></table>
</div>
</div><h4 id="bear-token-认证和授权">bear token 认证和授权</h4>
<p>创建一个 ServiceAccount，将它和 ClusterRole system:kubelet-api-admin 绑定，从而具有调用 kubelet API 的权限：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create sa kubelet-api-test
kubectl create clusterrolebinding kubelet-api-test --clusterrole<span class="o">=</span>system:kubelet-api-admin --serviceaccount<span class="o">=</span>default:kubelet-api-test
<span class="nv">SECRET</span><span class="o">=</span><span class="k">$(</span>kubectl get secrets <span class="p">|</span> grep kubelet-api-test <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span>
<span class="nv">TOKEN</span><span class="o">=</span><span class="k">$(</span>kubectl describe secret <span class="si">${</span><span class="nv">SECRET</span><span class="si">}</span> <span class="p">|</span> grep -E <span class="s1">&#39;^token&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span>
</code></pre></td></tr></table>
</div>
</div><p>尝试访问</p>
<ul>
<li>访问结果为认证通过</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">curl -s --cacert /etc/kubernetes/cert/ca.pem -H <span class="s2">&#34;Authorization: Bearer </span><span class="si">${</span><span class="nv">TOKEN</span><span class="si">}</span><span class="s2">&#34;</span> https://192.168.7.200:10250/metrics <span class="p">|</span> head
</code></pre></td></tr></table>
</div>
</div><ul>
<li>打印信息</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># HELP apiserver_audit_event_total [ALPHA] Counter of audit events generated and sent to the audit backend.</span>
<span class="c1"># TYPE apiserver_audit_event_total counter</span>
apiserver_audit_event_total <span class="m">0</span>
<span class="c1"># HELP apiserver_audit_requests_rejected_total [ALPHA] Counter of apiserver requests rejected due to an error in audit logging backend.</span>
<span class="c1"># TYPE apiserver_audit_requests_rejected_total counter</span>
apiserver_audit_requests_rejected_total <span class="m">0</span>
<span class="c1"># HELP apiserver_client_certificate_expiration_seconds [ALPHA] Distribution of the remaining lifetime on the certificate used to authenticate a request.</span>
<span class="c1"># TYPE apiserver_client_certificate_expiration_seconds histogram</span>
apiserver_client_certificate_expiration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">&#34;0&#34;</span><span class="o">}</span> <span class="m">0</span>
apiserver_client_certificate_expiration_seconds_bucket<span class="o">{</span><span class="nv">le</span><span class="o">=</span><span class="s2">&#34;1800&#34;</span><span class="o">}</span> <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="cadvisor-和-metrics">cadvisor 和 metrics</h4>
<p>cadvisor 是内嵌在 kubelet 二进制中的，统计所在节点各容器的资源(CPU、内存、磁盘、网卡)使用情况的服务。</p>
<p>浏览器访问 https://192.168.7.200:10250/metrics 和 https://192.168.7.200:10250/metrics/cadvisor 分别返回 kubelet 和 cadvisor 的 metrics。</p>
<p>注意：</p>
<ul>
<li>kubelet.config.json 设置 authentication.anonymous.enabled 为 false，不允许匿名证书访问 10250 的 https 服务；</li>
</ul>
<h3 id="部署-kube-proxy-组件">部署 kube-proxy 组件</h3>
<p>kube-proxy 运行在所有 worker 节点上，它监听 apiserver 中 service 和 endpoint 的变化情况，创建路由规则以提供服务 IP 和负载均衡功能。</p>
<p>本文档讲解部署 ipvs 模式的 kube-proxy 过程。</p>
<h4 id="创建-kube-proxy-证书">创建 kube-proxy 证书</h4>
<ul>
<li>CN：指定该证书的 User 为 <code>system:kube-proxy</code>；</li>
<li>预定义的 RoleBinding <code>system:node-proxier</code> 将User <code>system:kube-proxy</code> 与 Role <code>system:node-proxier</code> 绑定，该 Role 授予了调用 <code>kube-apiserver</code> Proxy 相关 API 的权限；</li>
<li>该证书只会被 kube-proxy 当做 client 证书使用，所以 hosts 字段为空；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cat &gt; kube-proxy-csr.json <span class="s">&lt;&lt;EOF
</span><span class="s">{
</span><span class="s">  &#34;CN&#34;: &#34;system:kube-proxy&#34;,
</span><span class="s">  &#34;key&#34;: {
</span><span class="s">    &#34;algo&#34;: &#34;rsa&#34;,
</span><span class="s">    &#34;size&#34;: 2048
</span><span class="s">  },
</span><span class="s">  &#34;names&#34;: [
</span><span class="s">    {
</span><span class="s">      &#34;C&#34;: &#34;CN&#34;,
</span><span class="s">      &#34;ST&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;L&#34;: &#34;BeiJing&#34;,
</span><span class="s">      &#34;O&#34;: &#34;k8s&#34;,
</span><span class="s">      &#34;OU&#34;: &#34;opsnull&#34;
</span><span class="s">    }
</span><span class="s">  ]
</span><span class="s">}
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>生成证书和私钥</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cfssl gencert -ca<span class="o">=</span>/opt/k8s/work/ca.pem <span class="se">\
</span><span class="se"></span>  -ca-key<span class="o">=</span>/opt/k8s/work/ca-key.pem <span class="se">\
</span><span class="se"></span>  -config<span class="o">=</span>/opt/k8s/work/ca-config.json <span class="se">\
</span><span class="se"></span>  -profile<span class="o">=</span>kubernetes  kube-proxy-csr.json <span class="p">|</span> cfssljson -bare kube-proxy
ls kube-proxy*
</code></pre></td></tr></table>
</div>
</div><h4 id="创建和分发-kubeconfig-文件-1">创建和分发 kubeconfig 文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
kubectl config set-cluster kubernetes <span class="se">\
</span><span class="se"></span>  --certificate-authority<span class="o">=</span>/opt/k8s/work/ca.pem <span class="se">\
</span><span class="se"></span>  --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --server<span class="o">=</span><span class="si">${</span><span class="nv">KUBE_APISERVER</span><span class="si">}</span> <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig

kubectl config set-credentials kube-proxy <span class="se">\
</span><span class="se"></span>  --client-certificate<span class="o">=</span>kube-proxy.pem <span class="se">\
</span><span class="se"></span>  --client-key<span class="o">=</span>kube-proxy-key.pem <span class="se">\
</span><span class="se"></span>  --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig

kubectl config set-context default <span class="se">\
</span><span class="se"></span>  --cluster<span class="o">=</span>kubernetes <span class="se">\
</span><span class="se"></span>  --user<span class="o">=</span>kube-proxy <span class="se">\
</span><span class="se"></span>  --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig

kubectl config use-context default --kubeconfig<span class="o">=</span>kube-proxy.kubeconfig
</code></pre></td></tr></table>
</div>
</div><p>分发</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_name in <span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_name</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kube-proxy.kubeconfig root@<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span>:/etc/kubernetes/
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建-kube-proxy-配置文件">创建 kube-proxy 配置文件</h4>
<p>从 v1.10 开始，kube-proxy <strong>部分参数</strong>可以配置文件中配置。可以使用 <code>--write-config-to</code> 选项生成该配置文件，或者参考 <a href="https://github.com/kubernetes/kubernetes/blob/release-1.14/pkg/proxy/apis/config/types.go" target="_blank" rel="noopener noreffer">源代码的注释</a>。</p>
<p>创建 kube-proxy config 文件模板：</p>
<ul>
<li><code>bindAddress</code>: 监听地址；</li>
<li><code>clientConnection.kubeconfig</code>: 连接 apiserver 的 kubeconfig 文件；</li>
<li><code>clusterCIDR</code>: kube-proxy 根据 <code>--cluster-cidr</code> 判断集群内部和外部流量，指定 <code>--cluster-cidr</code> 或 <code>--masquerade-all</code> 选项后 kube-proxy 才会对访问 Service IP 的请求做 SNAT；</li>
<li><code>hostnameOverride</code>: 参数值必须与 kubelet 的值一致，否则 kube-proxy 启动后会找不到该 Node，从而不会创建任何 ipvs 规则；</li>
<li><code>mode</code>: 使用 ipvs 模式；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
cat &gt; kube-proxy-config.yaml.template <span class="s">&lt;&lt;EOF
</span><span class="s">kind: KubeProxyConfiguration
</span><span class="s">apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span><span class="s">clientConnection:
</span><span class="s">  burst: 200
</span><span class="s">  kubeconfig: &#34;/etc/kubernetes/kube-proxy.kubeconfig&#34;
</span><span class="s">  qps: 100
</span><span class="s">bindAddress: ##NODE_IP##
</span><span class="s">healthzBindAddress: ##NODE_IP##:10256
</span><span class="s">metricsBindAddress: ##NODE_IP##:10249
</span><span class="s">enableProfiling: true
</span><span class="s">clusterCIDR: ${CLUSTER_CIDR}
</span><span class="s">hostnameOverride: ##NODE_NAME##
</span><span class="s">mode: &#34;ipvs&#34;
</span><span class="s">portRange: &#34;&#34;
</span><span class="s">iptables:
</span><span class="s">  masqueradeAll: false
</span><span class="s">ipvs:
</span><span class="s">  scheduler: rr
</span><span class="s">  excludeCIDRs: []
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>分发至各个节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> <span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span> i &lt; 3<span class="p">;</span> i++ <span class="o">))</span>
  <span class="k">do</span> 
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[i]</span><span class="si">}</span><span class="s2">&#34;</span>
    sed -e <span class="s2">&#34;s/##NODE_NAME##/</span><span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[i]</span><span class="si">}</span><span class="s2">/&#34;</span> -e <span class="s2">&#34;s/##NODE_IP##/</span><span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[i]</span><span class="si">}</span><span class="s2">/&#34;</span> kube-proxy-config.yaml.template &gt; kube-proxy-config-<span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[i]</span><span class="si">}</span>.yaml.template
    scp kube-proxy-config-<span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[i]</span><span class="si">}</span>.yaml.template root@<span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[i]</span><span class="si">}</span>:/etc/kubernetes/kube-proxy-config.yaml
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建和分发-kube-proxy-systemd-unit-文件">创建和分发 kube-proxy systemd unit 文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
cat &gt; kube-proxy.service <span class="s">&lt;&lt;EOF
</span><span class="s">[Unit]
</span><span class="s">Description=Kubernetes Kube-Proxy Server
</span><span class="s">Documentation=https://github.com/GoogleCloudPlatform/kubernetes
</span><span class="s">After=network.target
</span><span class="s">
</span><span class="s">[Service]
</span><span class="s">WorkingDirectory=${K8S_DIR}/kube-proxy
</span><span class="s">ExecStart=/opt/k8s/bin/kube-proxy \\
</span><span class="s">  --config=/etc/kubernetes/kube-proxy-config.yaml \\
</span><span class="s">  --logtostderr=true \\
</span><span class="s">  --v=2
</span><span class="s">Restart=on-failure
</span><span class="s">RestartSec=5
</span><span class="s">LimitNOFILE=65536
</span><span class="s">
</span><span class="s">[Install]
</span><span class="s">WantedBy=multi-user.target
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_name in <span class="si">${</span><span class="nv">NODE_NAMES</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span> 
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_name</span><span class="si">}</span><span class="s2">&#34;</span>
    scp kube-proxy.service root@<span class="si">${</span><span class="nv">node_name</span><span class="si">}</span>:/etc/systemd/system/
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="启动-kube-proxy-服务">启动 kube-proxy 服务</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
<span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;mkdir -p </span><span class="si">${</span><span class="nv">K8S_DIR</span><span class="si">}</span><span class="s2">/kube-proxy&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;modprobe ip_vs_rr&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl restart kube-proxy&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>检查启动结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;systemctl status kube-proxy|grep Active&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="查看监听端口">查看监听端口</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">netstat -lnpt<span class="p">|</span>grep kube-prox
</code></pre></td></tr></table>
</div>
</div><ul>
<li>10249：http prometheus metrics port;</li>
<li>10256：http healthz port;</li>
</ul>
<h4 id="查看-ipvs-路由规则">查看 ipvs 路由规则</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh root@<span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;/usr/sbin/ipvsadm -ln&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>预期结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">IP Virtual Server version 1.2.1 <span class="o">(</span><span class="nv">size</span><span class="o">=</span>4096<span class="o">)</span>
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.254.0.1:443 rr
  -&gt; 192.168.7.200:6443           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>         
  -&gt; 192.168.7.201:6443           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>         
  -&gt; 192.168.7.202:6443           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>         
&gt;&gt;&gt; 192.168.7.201
IP Virtual Server version 1.2.1 <span class="o">(</span><span class="nv">size</span><span class="o">=</span>4096<span class="o">)</span>
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.254.0.1:443 rr
  -&gt; 192.168.7.200:6443           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>         
  -&gt; 192.168.7.201:6443           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>         
  -&gt; 192.168.7.202:6443           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>         
&gt;&gt;&gt; 192.168.7.202
IP Virtual Server version 1.2.1 <span class="o">(</span><span class="nv">size</span><span class="o">=</span>4096<span class="o">)</span>
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.254.0.1:443 rr
  -&gt; 192.168.7.200:6443           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>         
  -&gt; 192.168.7.201:6443           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>         
  -&gt; 192.168.7.202:6443           Masq    <span class="m">1</span>      <span class="m">0</span>          <span class="m">0</span>    
</code></pre></td></tr></table>
</div>
</div><p>可见所有通过 https 访问 K8S SVC kubernetes 的请求都转发到 kube-apiserver 节点的 6443 端口；</p>
<h3 id="部署calico网络组件">部署Calico网络组件</h3>
<p>calico 使用 IPIP 或 BGP 技术（默认为 IPIP）为各节点创建一个可以互通的 Pod 网络。</p>
<h4 id="安装部署-1">安装部署</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
curl https://docs.projectcalico.org/manifests/calico.yaml -O
</code></pre></td></tr></table>
</div>
</div><p>修改配置：</p>
<ul>
<li>calico 自动探查互联网卡，如果有多网卡，则可以配置用于互联的网络接口命名正则表达式，如上面的 <code>ens.*</code>(根据自己服务器的网络接口名修改)；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">cp calico.yaml calico.yaml.orig
vim calico.yaml
diff calico.yaml.orig calico.yaml
&lt;             <span class="c1"># - name: CALICO_IPV4POOL_CIDR</span>
&lt;             <span class="c1">#   value: &#34;192.168.0.0/16&#34;</span>
---
&gt;             - name: CALICO_IPV4POOL_CIDR
&gt;               value: <span class="s2">&#34;172.30.0.0/16&#34;</span>
&gt;             - name: IP_AUTODETECTION_METHOD
&gt;               value: <span class="s2">&#34;interface=ens.*&#34;</span>
3649c3651
&lt;             path: /opt/cni/bin
---
&gt;             path: /opt/k8s/bin
</code></pre></td></tr></table>
</div>
</div><p>部署 calico</p>
<ul>
<li>calico 插架以 daemonset 方式运行在所有的 K8S 节点上</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f  calico.yaml
</code></pre></td></tr></table>
</div>
</div><h4 id="检查-calico">检查 calico</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get pods -n kube-system -o wide
</code></pre></td></tr></table>
</div>
</div><p>使用 crictl 命令查看 calico 使用的镜像</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">crictl images
</code></pre></td></tr></table>
</div>
</div><p>如果 crictl 输出为空或执行失败，则有可能是缺少配置文件 <code>/etc/crictl.yaml</code> 导致的，该文件的配置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">cat /etc/crictl.yaml

runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: <span class="m">10</span>
debug: <span class="nb">false</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="验证功能">验证功能</h2>
<h3 id="检查节点功能">检查节点功能</h3>
<ul>
<li>都为 Ready 且版本为 v1.16.6 时正常。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get nodes
</code></pre></td></tr></table>
</div>
</div><h3 id="创建测试文件">创建测试文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">cd</span> /opt/k8s/work
cat &gt; nginx-ds.yml <span class="s">&lt;&lt;EOF
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Service
</span><span class="s">metadata:
</span><span class="s">  name: nginx-ds
</span><span class="s">  labels:
</span><span class="s">    app: nginx-ds
</span><span class="s">spec:
</span><span class="s">  type: NodePort
</span><span class="s">  selector:
</span><span class="s">    app: nginx-ds
</span><span class="s">  ports:
</span><span class="s">  - name: http
</span><span class="s">    port: 80
</span><span class="s">    targetPort: 80
</span><span class="s">---
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: DaemonSet
</span><span class="s">metadata:
</span><span class="s">  name: nginx-ds
</span><span class="s">  labels:
</span><span class="s">    addonmanager.kubernetes.io/mode: Reconcile
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      app: nginx-ds
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      labels:
</span><span class="s">        app: nginx-ds
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: my-nginx
</span><span class="s">        image: nginx:1.7.9
</span><span class="s">        ports:
</span><span class="s">        - containerPort: 80
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="执行测试">执行测试</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create -f nginx-ds.yml
</code></pre></td></tr></table>
</div>
</div><h3 id="检查节点-pod-ip-连通性">检查节点 POD IP 连通性</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"> kubectl get pods  -o wide -l <span class="nv">app</span><span class="o">=</span>nginx-ds
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">NAME             READY STATUS   RESTARTS  AGE    IP              NODE        NOMINATED NODE  READINESS GATES
nginx-ds-5qszv   1/1   Running  <span class="m">0</span>         4h25m  172.30.135.129  k8s-node03  &lt;none&gt;          &lt;none&gt;
nginx-ds-n5tzp   1/1   Running  <span class="m">0</span>         4h25m  172.30.85.193   k8s-node01  &lt;none&gt;          &lt;none&gt;
nginx-ds-pdsp2   1/1   Running  <span class="m">0</span>         4h25m  172.30.58.194   k8s-node02  &lt;none&gt;          &lt;none&gt;
</code></pre></td></tr></table>
</div>
</div><p>在所有的 Node上对 Pod IP 进行联通性测试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh <span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;ping -c 1 172.30.135.129&#34;</span>
    ssh <span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;ping -c 1 172.30.85.193&#34;</span>
    ssh <span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;ping -c 1 172.30.58.194&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="检查服务ip-和-端口可达性">检查服务IP 和 端口可达性</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"> kubectl get svc -l <span class="nv">app</span><span class="o">=</span>nginx-ds    
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">NAME       TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
nginx-ds   NodePort   10.254.217.207   &lt;none&gt;        80:32716/TCP   4h30m
</code></pre></td></tr></table>
</div>
</div><p>通过信息可以看出</p>
<ul>
<li>Service Cluster IP：10.254.217.207</li>
<li>服务端口：80</li>
<li>NodePort：32716</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh <span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;curl -s 10.254.217.207&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>预期打印 Nginx 信息</p>
<h3 id="检查服务-nodeport-可达性">检查服务 NodePort 可达性</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">source</span> /opt/k8s/bin/environment.sh
<span class="k">for</span> node_ip in <span class="si">${</span><span class="nv">NODE_IPS</span><span class="p">[@]</span><span class="si">}</span>
  <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt;&gt; </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">&#34;</span>
    ssh <span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span> <span class="s2">&#34;curl -s </span><span class="si">${</span><span class="nv">node_ip</span><span class="si">}</span><span class="s2">:32716&#34;</span>
  <span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>预期打印 Nginx 信息</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-08-11</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://www.viper.pub/k8s-install-hardway-3/" data-title="二进制部署Kubernetes Part3" data-hashtags="Kubernetes"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://www.viper.pub/k8s-install-hardway-3/" data-hashtag="Kubernetes"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://www.viper.pub/k8s-install-hardway-3/" data-title="二进制部署Kubernetes Part3" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://www.viper.pub/k8s-install-hardway-3/" data-title="二进制部署Kubernetes Part3"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://www.viper.pub/k8s-install-hardway-3/" data-title="二进制部署Kubernetes Part3" data-image="https://gitee.com/AbyssViper/pic/raw/master/images/k8s-install-hardway/featuredImage3.png"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://www.viper.pub/k8s-install-hardway-3/" data-title="二进制部署Kubernetes Part3" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg"></i></a><a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://www.viper.pub/k8s-install-hardway-3/" data-title="二进制部署Kubernetes Part3" data-description=""><i class="fab fa-blogger fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://www.viper.pub/k8s-install-hardway-3/" data-title="二进制部署Kubernetes Part3"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/kubernetes/">Kubernetes</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/k8s-install-hardway-2/" class="prev" rel="prev" title="二进制部署Kubernetes Part2"><i class="fas fa-angle-left fa-fw"></i>二进制部署Kubernetes Part2</a>
            <a href="/k8s-install-hardway-4/" class="next" rel="next" title="K8s Install Hardway 4">K8s Install Hardway 4<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk"></a>Gitalk</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.74.3">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2020</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.71b52de752d829104ec4119a58460549.css" integrity="md5-cbUt51LYKRBOxBGaWEYFSQ=="><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.77eb6ae63c63c88c5e7a10b6c9570c54.css" integrity="md5-d&#43;tq5jxjyIxeehC2yVcMVA=="><link rel="stylesheet" href="/lib/katex/katex.min.ef3c395634e43fe45f5332bfca2287b3.css" integrity="md5-7zw5VjTkP&#43;RfUzK/yiKHsw=="><link rel="stylesheet" href="/lib/katex/copy-tex.min.622133ef544b0f203604a52bebba29f4.css" integrity="md5-YiEz71RLDyA2BKUr67op9A=="><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.4c5305a5255032858d47ae995b20aeca.css" integrity="md5-TFMFpSVQMoWNR66ZWyCuyg=="><script type="text/javascript" src="/lib/gitalk/gitalk.min.ec4a60342c0b98209772ebf3fdec0aa2.js" integrity="md5-7EpgNCwLmCCXcuvz/ewKog=="></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.dd4e1772a44268dd6e27f193695067fc.js" integrity="md5-3U4XcqRCaN1uJ/GTaVBn/A=="></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.10321080d79e27ee01ff36859c02acd3.js" integrity="md5-EDIQgNeeJ&#43;4B/zaFnAKs0w=="></script><script type="text/javascript" src="/lib/lunr/lunr.min.f2eea188dc4939c55ff8f55569a4e87c.js" integrity="md5-8u6hiNxJOcVf&#43;PVVaaTofA=="></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.b82fb8d93ce0ea6a485dfa3a0b1e7573.js" integrity="md5-uC&#43;42Tzg6mpIXfo6Cx51cw=="></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.f1ba3e22560e2eb7474f28feb4507617.js" integrity="md5-8bo&#43;IlYOLrdHTyj&#43;tFB2Fw=="></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.40c0bfc764764587555c066d46fe6071.js" integrity="md5-QMC/x2R2RYdVXAZtRv5gcQ=="></script><script type="text/javascript" src="/lib/twemoji/twemoji.min.c6a5b6b1db8980fdc42cd3456fe1ec74.js" integrity="md5-xqW2sduJgP3ELNNFb&#43;HsdA=="></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.ba38a712df31c778e10e8211f8cb891b.js" integrity="md5-ujinEt8xx3jhDoIR&#43;MuJGw=="></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.fa56076f9d071729612c4849acae1ce5.js" integrity="md5-&#43;lYHb50HFylhLEhJrK4c5Q=="></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.4f0896a2ff5ef76f0dd00f5c5de65abb.js" integrity="md5-TwiWov9e928N0A9cXeZauw=="></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.221393f48062472d1e72960fda7db7a3.js" integrity="md5-IhOT9IBiRy0ecpYP2n23ow=="></script><script type="text/javascript" src="/lib/sharer/sharer.min.5625619b1285f17b13aee3f397116aa6.js" integrity="md5-ViVhmxKF8XsTruPzlxFqpg=="></script><script type="text/javascript" src="/lib/katex/katex.min.c158c9e823b681cf535f46596b5e4eac.js" integrity="md5-wVjJ6CO2gc9TX0ZZa15OrA=="></script><script type="text/javascript" src="/lib/katex/auto-render.min.28cd0b98cd3f4fa37d52f3ffe47ad9d4.js" integrity="md5-KM0LmM0/T6N9UvP/5HrZ1A=="></script><script type="text/javascript" src="/lib/katex/copy-tex.min.bfaec7d1dea915d74a7a6d833f0ff62e.js" integrity="md5-v67H0d6pFddKem2DPw/2Lg=="></script><script type="text/javascript" src="/lib/katex/mhchem.min.1bbb252363e83547d4b2186a41eaca28.js" integrity="md5-G7slI2PoNUfUshhqQerKKA=="></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.4a48532bf0b17c058b8b6854f49de23f.js" integrity="md5-SkhTK/CxfAWLi2hU9J3iPw=="></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"gitalk":{"admin":["AbyssViper"],"clientID":"6902cde2aae313788a4c","clientSecret":"81fc2e7de744fca69c9e8b683e85e50a2bb5951c","id":"2019-12-10T06:51:03+08:00","owner":"AbyssViper","repo":"AbyssViper.github.io","title":"二进制部署Kubernetes Part3"}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"twemoji":true};</script><script type="text/javascript" src="/js/theme.min.8043ef4f5ae2d4fd302305ffd8316f55.js" integrity="md5-gEPvT1ri1P0wIwX/2DFvVQ=="></script></body>
</html>
